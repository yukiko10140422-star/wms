<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GMS — Global Mango System</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --mango:#ff8c00;--mango-light:#fff3e0;--mango-dark:#e65c00;
  --yellow:#ffc107;--yellow-light:#fffde7;
  --bg:#fff8f0;--white:#ffffff;--ink:#2d1a00;--muted:#8a6a40;
  --border:#f0d9b5;--border-dark:#e0b87a;
  --green:#2e7d32;--green-light:#e8f5e9;
  --red:#c62828;--red-light:#ffebee;
  --shadow:0 2px 8px rgba(255,140,0,.10),0 1px 3px rgba(0,0,0,.06);
  --shadow-lg:0 8px 32px rgba(255,140,0,.18);
  --radius:12px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--ink);font-family:'Noto Sans JP',sans-serif;min-height:100vh;}
#sync-bar{position:fixed;top:0;left:0;right:0;height:3px;z-index:300;}
#sync-bar.loading{background:linear-gradient(90deg,var(--mango),var(--yellow));animation:pulse 1s infinite;}
#sync-bar.ok{background:var(--green);animation:fadeout 1.2s forwards .8s;}
#sync-bar.err{background:var(--red);}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
@keyframes fadeout{to{opacity:0}}
.sync-toast{position:fixed;bottom:1.2rem;right:1.2rem;background:var(--ink);color:#fff;border-radius:9px;padding:.55rem 1rem;font-size:.8rem;display:flex;align-items:center;gap:.5rem;box-shadow:var(--shadow-lg);z-index:300;transform:translateY(20px);opacity:0;transition:all .25s;}
.sync-toast.show{transform:translateY(0);opacity:1;}
.app-shell{display:flex;min-height:100vh;}
.sidebar{width:235px;background:linear-gradient(180deg,#e65c00 0%,#ff8c00 50%,#ffa000 100%);color:#fff;padding:1.4rem 1rem;display:flex;flex-direction:column;gap:1.5rem;flex-shrink:0;position:sticky;top:0;height:100vh;overflow-y:auto;}
.brand{border-bottom:1px solid rgba(255,255,255,.2);padding-bottom:1.2rem;}
.brand-logo{font-size:2rem;margin-bottom:.3rem;}
.brand-name{font-size:1.05rem;font-weight:900;letter-spacing:.5px;color:#fff;}
.brand-sub{font-size:.58rem;color:rgba(255,255,255,.6);letter-spacing:2px;text-transform:uppercase;margin-top:2px;}
.sync-info{margin-top:.4rem;font-size:.62rem;color:rgba(255,255,255,.5);display:flex;align-items:center;gap:.3rem;}
.sync-dot{width:6px;height:6px;border-radius:50%;background:#fff;flex-shrink:0;}
.sync-dot.offline{background:rgba(255,255,255,.3);}
.nav-section{font-size:.57rem;font-weight:700;letter-spacing:2px;color:rgba(255,255,255,.45);text-transform:uppercase;margin-bottom:.2rem;}
.nav-btn{display:flex;align-items:center;gap:.5rem;width:100%;background:none;border:none;color:rgba(255,255,255,.75);padding:.48rem .65rem;border-radius:8px;cursor:pointer;font-family:'Noto Sans JP',sans-serif;font-size:.84rem;font-weight:500;text-align:left;transition:all .15s;margin-bottom:1px;}
.nav-btn:hover{background:rgba(255,255,255,.15);color:#fff;}
.nav-btn.active{background:rgba(255,255,255,.22);color:#fff;font-weight:700;}
.nav-btn .icon{font-size:.88rem;width:.95rem;text-align:center;flex-shrink:0;}
.lock-icon{font-size:.62rem;opacity:.5;margin-left:auto;}
.main{flex:1;padding:2rem;max-width:960px;overflow-x:hidden;}
.page{display:none;}
.page.active{display:block;animation:fadein .2s ease;}
@keyframes fadein{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
.page-header{margin-bottom:1.4rem;}
.page-header h2{font-size:1.4rem;font-weight:900;}
.page-header p{font-size:.82rem;color:var(--muted);margin-top:.22rem;}
.card{background:var(--white);border-radius:var(--radius);padding:1.15rem 1.35rem;box-shadow:var(--shadow);margin-bottom:.9rem;border:1.5px solid var(--border);}
.card-head{font-size:.68rem;font-weight:700;letter-spacing:1.5px;color:var(--mango-dark);text-transform:uppercase;margin-bottom:.85rem;padding-bottom:.55rem;border-bottom:1.5px solid var(--mango-light);}
.field{display:flex;flex-direction:column;gap:.28rem;}
.field label{font-size:.68rem;font-weight:700;color:var(--muted);}
input,select,textarea{padding:.52rem .78rem;border:1.5px solid var(--border);border-radius:8px;font-family:'Noto Sans JP',sans-serif;font-size:.87rem;color:var(--ink);background:#fff;outline:none;transition:border-color .15s;width:100%;}
input:focus,select:focus,textarea:focus{border-color:var(--mango);box-shadow:0 0 0 3px rgba(255,140,0,.1);}
textarea{resize:vertical;min-height:68px;}
.field-row{display:flex;gap:.7rem;flex-wrap:wrap;}
.field-row.col2>*{flex:1;min-width:155px;}
.field-row.col3>*{flex:1;min-width:115px;}
.btn{padding:.5rem 1.05rem;border-radius:8px;border:none;cursor:pointer;font-family:'Noto Sans JP',sans-serif;font-size:.84rem;font-weight:700;transition:all .15s;display:inline-flex;align-items:center;gap:.3rem;}
.btn-primary{background:var(--mango);color:#fff;}
.btn-primary:hover{background:var(--mango-dark);}
.btn-secondary{background:var(--mango-light);color:var(--mango-dark);border:1.5px solid var(--border-dark);}
.btn-secondary:hover{background:#ffe0b2;}
.btn-green{background:var(--green);color:#fff;}
.btn-green:hover{background:#1b5e20;}
.btn-sm{padding:.32rem .7rem;font-size:.73rem;}
.btn-group{display:flex;gap:.55rem;flex-wrap:wrap;margin-top:.9rem;}
.btn:disabled{opacity:.5;cursor:not-allowed;}
/* Worker picker */
.worker-picker{display:flex;gap:.45rem;flex-wrap:wrap;margin-bottom:.75rem;}
.worker-chip{display:flex;align-items:center;gap:.4rem;padding:.42rem .8rem;background:var(--mango-light);border:1.5px solid var(--border);border-radius:99px;cursor:pointer;transition:all .13s;font-size:.82rem;font-weight:500;}
.worker-chip:hover{border-color:var(--mango);background:#ffe0b2;}
.worker-chip.selected{background:var(--mango);border-color:var(--mango-dark);color:#fff;font-weight:700;}
.avatar{width:26px;height:26px;border-radius:50%;object-fit:cover;flex-shrink:0;}
.avatar-placeholder{width:26px;height:26px;border-radius:50%;background:linear-gradient(135deg,var(--yellow),var(--mango));display:flex;align-items:center;justify-content:center;font-size:.72rem;font-weight:900;color:#fff;flex-shrink:0;}
.avatar-lg{width:50px;height:50px;font-size:1.15rem;}
/* Proc */
.proc-header{display:grid;grid-template-columns:1fr 85px 85px 85px;gap:.45rem;font-size:.65rem;font-weight:700;color:var(--muted);padding:.28rem .05rem;margin-bottom:.25rem;}
.proc-row{display:grid;grid-template-columns:1fr 85px 85px 85px;gap:.45rem;align-items:center;padding:.38rem .05rem;border-radius:7px;transition:background .1s;}
.proc-row.has-value{background:var(--mango-light);}
.proc-name{font-size:.84rem;font-weight:500;}
.proc-subtotal{font-family:'DM Mono',monospace;font-size:.82rem;color:var(--muted);text-align:right;}
.proc-subtotal.active{color:var(--mango-dark);font-weight:700;}
.proc-row input[type=number]{text-align:center;padding:.35rem .28rem;font-size:.84rem;}
/* Bonus */
.bonus-toggle{display:flex;align-items:center;gap:.7rem;background:var(--yellow-light);border:1.5px solid var(--yellow);border-radius:10px;padding:.65rem .95rem;cursor:pointer;user-select:none;transition:all .15s;margin-bottom:.85rem;}
.bonus-toggle.on{background:var(--mango-light);border-color:var(--mango);}
.tog-switch{width:34px;height:19px;background:#ddd;border-radius:99px;position:relative;flex-shrink:0;transition:background .2s;}
.bonus-toggle.on .tog-switch{background:var(--mango);}
.tog-switch::after{content:'';position:absolute;width:15px;height:15px;background:#fff;border-radius:50%;top:2px;left:2px;transition:transform .2s;box-shadow:0 1px 2px rgba(0,0,0,.2);}
.bonus-toggle.on .tog-switch::after{transform:translateX(15px);}
.tog-main{font-weight:700;font-size:.87rem;color:var(--ink);}
.tog-sub{font-size:.68rem;color:var(--muted);}
/* Total card */
.total-card{background:linear-gradient(135deg,#e65c00,#ff8c00,#ffa000);border:none;color:#fff;}
.total-card .card-head{color:rgba(255,255,255,.55);border-bottom-color:rgba(255,255,255,.18);}
.total-row{display:flex;justify-content:space-between;align-items:baseline;padding:.28rem 0;font-size:.84rem;color:rgba(255,255,255,.85);}
.total-row.bold{font-weight:700;color:#fff;}
.total-sep{border:none;border-top:1px solid rgba(255,255,255,.2);margin:.38rem 0;}
.grand-total{display:flex;justify-content:space-between;align-items:baseline;padding:.52rem 0 0;border-top:2px solid rgba(255,255,255,.28);margin-top:.38rem;}
.gt-label{font-size:.87rem;font-weight:700;color:#fff;}
.gt-amount{font-family:'DM Mono',monospace;font-size:1.65rem;font-weight:700;color:#fff;}
/* History */
.history-controls{display:flex;gap:.7rem;flex-wrap:wrap;margin-bottom:1rem;}
.history-card{background:var(--white);border-radius:var(--radius);border:1.5px solid var(--border);overflow:hidden;margin-bottom:.55rem;box-shadow:var(--shadow);}
.history-card-head{display:flex;align-items:center;gap:.7rem;padding:.75rem .95rem;cursor:pointer;}
.history-card-head:hover{background:var(--mango-light);}
.history-meta{flex:1;display:flex;flex-direction:column;gap:.1rem;}
.history-name{font-weight:700;font-size:.9rem;}
.history-date{font-size:.7rem;color:var(--muted);}
.history-amount{font-family:'DM Mono',monospace;font-weight:700;font-size:.98rem;color:var(--mango-dark);}
.history-status{font-size:.62rem;font-weight:700;padding:.16rem .48rem;border-radius:99px;}
.status-pending{background:#fff3e0;color:#e65c00;}
.status-approved{background:var(--green-light);color:var(--green);}
.status-rejected{background:var(--red-light);color:var(--red);}
.detail-panel{display:none;padding:.75rem .95rem;border-top:1.5px solid var(--border);background:var(--mango-light);}
.detail-panel.open{display:block;}
.detail-table{width:100%;border-collapse:collapse;font-size:.78rem;margin-bottom:.55rem;}
.detail-table th{text-align:left;color:var(--muted);font-weight:700;padding:.28rem .38rem;font-size:.65rem;border-bottom:1.5px solid var(--border);}
.detail-table td{padding:.28rem .38rem;border-bottom:1px solid var(--border);}
.detail-table td.num{text-align:right;font-family:'DM Mono',monospace;}
/* Month summary */
.month-summary{background:var(--yellow-light);border:1.5px solid var(--yellow);border-radius:10px;padding:.85rem 1.05rem;margin-bottom:1rem;display:flex;gap:1.4rem;flex-wrap:wrap;}
.ms-item{display:flex;flex-direction:column;gap:.12rem;}
.ms-label{font-size:.63rem;font-weight:700;color:var(--muted);}
.ms-val{font-size:1.02rem;font-weight:900;color:var(--mango-dark);font-family:'DM Mono',monospace;}
/* Settings */
.worker-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(145px,1fr));gap:.7rem;margin-bottom:.85rem;}
.worker-card-sm{background:var(--mango-light);border-radius:10px;padding:.8rem;display:flex;flex-direction:column;align-items:center;gap:.28rem;text-align:center;position:relative;border:1.5px solid var(--border);}
.del-btn{position:absolute;top:.32rem;right:.32rem;background:rgba(198,40,40,.08);border:none;color:var(--red);border-radius:50%;width:19px;height:19px;cursor:pointer;font-size:.6rem;display:flex;align-items:center;justify-content:center;}
.del-btn:hover{background:var(--red);color:#fff;}
.wname{font-weight:700;font-size:.83rem;}
.waddr{font-size:.66rem;color:var(--muted);}
.price-row{display:flex;align-items:center;gap:.45rem;padding:.38rem .18rem;border-bottom:1px solid var(--border);}
.price-row span{flex:1;font-size:.82rem;}
/* Bank */
.bank-box{background:var(--yellow-light);border:1.5px solid var(--yellow);border-radius:9px;padding:.75rem .95rem;margin-top:.45rem;}
.bank-title{font-size:.6rem;font-weight:700;letter-spacing:1px;color:var(--mango-dark);text-transform:uppercase;margin-bottom:.5rem;}
.bank-grid{display:grid;grid-template-columns:1fr 1fr;gap:.42rem;}
.bank-field{display:flex;flex-direction:column;gap:.16rem;}
.bank-field label{font-size:.62rem;font-weight:700;color:var(--muted);}
/* Timer */
.timer-card{background:linear-gradient(135deg,#3e1f00,#6d3b00);color:#fff;border:none;}
.timer-card .card-head{color:rgba(255,255,255,.38);border-bottom-color:rgba(255,255,255,.1);}
.timer-display{font-family:'DM Mono',monospace;font-size:2.7rem;font-weight:500;letter-spacing:3px;text-align:center;color:#fff;padding:.38rem 0;line-height:1;}
.timer-status{text-align:center;font-size:.72rem;color:rgba(255,255,255,.38);margin-top:.22rem;margin-bottom:.85rem;}
.timer-status.running{color:#4ade80;}
.timer-status.paused{color:var(--yellow);}
.timer-btns{display:flex;gap:.45rem;justify-content:center;flex-wrap:wrap;}
.timer-log{margin-top:.8rem;border-top:1px solid rgba(255,255,255,.1);padding-top:.65rem;}
.timer-log-title{font-size:.58rem;font-weight:700;letter-spacing:2px;color:rgba(255,255,255,.28);text-transform:uppercase;margin-bottom:.38rem;}
.timer-log-list{display:flex;flex-direction:column;gap:.22rem;max-height:100px;overflow-y:auto;}
.timer-log-item{display:flex;justify-content:space-between;font-size:.7rem;color:rgba(255,255,255,.45);font-family:'DM Mono',monospace;padding:.12rem 0;border-bottom:1px solid rgba(255,255,255,.05);}
.timer-total-row{display:flex;justify-content:space-between;margin-top:.42rem;padding-top:.42rem;border-top:1px solid rgba(255,255,255,.13);font-size:.78rem;color:#fff;font-family:'DM Mono',monospace;font-weight:500;}
/* Shift */
.shift-card{background:linear-gradient(135deg,#e65c00,#ff8c00,#ffc107);color:#fff;border:none;}
.shift-card .card-head{color:rgba(255,255,255,.48);border-bottom-color:rgba(255,255,255,.15);}
.shift-month-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:.6rem;}
.shift-month-nav button{background:rgba(255,255,255,.15);border:none;color:#fff;border-radius:7px;padding:.28rem .62rem;cursor:pointer;font-size:.88rem;}
.shift-month-nav button:hover{background:rgba(255,255,255,.25);}
.shift-month-title{font-size:.98rem;font-weight:700;color:#fff;}
.shift-cal-head{text-align:center;font-size:.6rem;font-weight:700;color:rgba(255,255,255,.38);padding:.22rem 0;}
.shift-cal-head.sun{color:#fca5a5;}
.shift-cal-head.sat{color:#93c5fd;}
.shift-day{aspect-ratio:1;border-radius:7px;border:1.5px solid rgba(255,255,255,.15);display:flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:500;cursor:pointer;transition:all .12s;color:rgba(255,255,255,.82);user-select:none;}
.shift-day:hover{border-color:rgba(255,255,255,.4);background:rgba(255,255,255,.1);}
.shift-day.selected{background:#fff;border-color:#fff;color:var(--mango-dark);font-weight:900;}
.shift-day.past{opacity:.22;pointer-events:none;}
.shift-day.empty{border:none;cursor:default;}
.shift-day.sun{color:#fca5a5;}
.shift-day.sat{color:#93c5fd;}
.shift-day.selected.sun,.shift-day.selected.sat{color:var(--mango-dark);}
/* Shift admin */
.shift-admin-head{text-align:center;font-size:.58rem;font-weight:700;color:var(--muted);padding:.2rem 0;}
.shift-admin-day{min-height:48px;border-radius:7px;background:#fff;border:1.5px solid var(--border);padding:.22rem;overflow:hidden;}
.shift-admin-day.today{border-color:var(--mango);background:var(--mango-light);}
.shift-admin-day .day-num{font-size:.6rem;font-weight:700;color:var(--muted);}
.shift-chip{font-size:.5rem;background:var(--mango-light);color:var(--mango-dark);border-radius:3px;padding:1px 3px;margin-top:2px;display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.shift-chip.approved{background:var(--green-light);color:var(--green);}
.shift-chip.rejected{background:var(--red-light);color:var(--red);text-decoration:line-through;}
.shift-list-item{display:flex;align-items:center;gap:.7rem;background:#fff;border-radius:9px;padding:.65rem .95rem;border:1.5px solid var(--border);flex-wrap:wrap;margin-bottom:.45rem;}
.shift-list-item.approved{border-color:#a5d6a7;}
.shift-list-item.rejected{border-color:#ef9a9a;opacity:.62;}
.shift-status-badge{font-size:.6rem;font-weight:700;border-radius:99px;padding:.16rem .48rem;}
.shift-status-badge.pending{background:#fff3e0;color:#e65c00;}
.shift-status-badge.approved{background:var(--green-light);color:var(--green);}
.shift-status-badge.rejected{background:var(--red-light);color:var(--red);}
/* Modals */
.pw-overlay,.modal-overlay{position:fixed;inset:0;background:rgba(45,26,0,.82);z-index:500;display:flex;align-items:center;justify-content:center;padding:1rem;backdrop-filter:blur(5px);}
.pw-overlay.hidden,.modal-overlay.hidden{display:none;}
.pw-box{background:#fff;border-radius:14px;width:min(370px,94vw);padding:1.8rem;box-shadow:var(--shadow-lg);}
.pw-box h3{font-size:1.02rem;font-weight:900;margin-bottom:.32rem;}
.pw-box p{font-size:.77rem;color:var(--muted);margin-bottom:.95rem;line-height:1.6;}
.pw-box input{width:100%;border:1.5px solid var(--border);border-radius:8px;padding:.58rem .82rem;font-size:.98rem;font-family:'DM Mono',monospace;letter-spacing:3px;margin-bottom:.62rem;text-align:center;}
.pw-box input:focus{border-color:var(--mango);}
.pw-error{color:var(--red);font-size:.73rem;text-align:center;min-height:1.1em;margin-bottom:.42rem;}
.pw-btns{display:flex;gap:.45rem;}
.modal-box{background:#fff;border-radius:14px;width:min(555px,96vw);max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-lg);}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:1.05rem 1.35rem;border-bottom:1.5px solid var(--border);}
.modal-header h3{font-size:.98rem;font-weight:900;}
.modal-close{background:none;border:none;font-size:1.25rem;cursor:pointer;color:var(--muted);padding:.18rem .38rem;border-radius:6px;}
.modal-close:hover{background:var(--mango-light);}
.modal-body{padding:1.15rem 1.35rem;}
.modal-section{font-size:.6rem;font-weight:700;letter-spacing:2px;color:var(--mango);text-transform:uppercase;margin:1rem 0 .5rem;}
.modal-footer{padding:.8rem 1.35rem;border-top:1.5px solid var(--border);display:flex;gap:.45rem;justify-content:flex-end;}
.modal-avatar-row{display:flex;align-items:center;gap:.95rem;margin-bottom:.75rem;}
.avatar-upload{position:relative;cursor:pointer;}
.avatar-upload input[type="file"]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.avatar-upload-ring{width:50px;height:50px;border-radius:50%;border:2px dashed var(--border-dark);display:flex;align-items:center;justify-content:center;font-size:1.25rem;color:var(--muted);background:var(--bg);}
.avatar-upload:hover .avatar-upload-ring{border-color:var(--mango);background:var(--mango-light);}
.avatar-upload-ring.has-img{border-style:solid;border-color:var(--mango);}
.print-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:600;overflow-y:auto;padding:2rem;}
.print-overlay.open{display:block;}
.print-actions{display:flex;gap:.5rem;justify-content:center;margin-bottom:1rem;}
.no-print{}
.bonus-rate-field{display:flex;align-items:center;gap:.4rem;background:var(--yellow-light);border:1.5px solid var(--yellow);border-radius:7px;padding:.42rem .72rem;}
.icon-btn{background:none;border:none;cursor:pointer;padding:.22rem .38rem;border-radius:5px;font-size:.8rem;}
.icon-btn:hover{background:var(--mango-light);}
@media print{.no-print{display:none!important}}

/* ── MOBILE RESPONSIVE ── */
.mobile-topbar{display:none;position:fixed;top:0;left:0;right:0;z-index:200;background:linear-gradient(90deg,#e65c00,#ff8c00);padding:.7rem 1rem;align-items:center;justify-content:space-between;box-shadow:0 2px 8px rgba(0,0,0,.18);}
.mobile-brand{display:flex;align-items:center;gap:.5rem;color:#fff;font-weight:900;font-size:.98rem;}
.mobile-brand .mlogo{font-size:1.25rem;}
.hamburger{background:none;border:none;cursor:pointer;padding:.28rem;display:flex;flex-direction:column;gap:5px;}
.hamburger span{display:block;width:22px;height:2px;background:#fff;border-radius:2px;transition:all .2s;}
.hamburger.open span:nth-child(1){transform:translateY(7px) rotate(45deg);}
.hamburger.open span:nth-child(2){opacity:0;}
.hamburger.open span:nth-child(3){transform:translateY(-7px) rotate(-45deg);}
.mobile-drawer{position:fixed;inset:0;z-index:190;pointer-events:none;}
.mobile-drawer.open{pointer-events:auto;}
.drawer-backdrop{position:absolute;inset:0;background:rgba(45,26,0,.55);opacity:0;transition:opacity .25s;}
.mobile-drawer.open .drawer-backdrop{opacity:1;}
.drawer-panel{position:absolute;top:0;left:0;bottom:0;width:255px;background:linear-gradient(180deg,#e65c00,#ff8c00 50%,#ffa000);padding:4.5rem 1rem 1.5rem;display:flex;flex-direction:column;gap:1.3rem;transform:translateX(-100%);transition:transform .25s cubic-bezier(.4,0,.2,1);overflow-y:auto;}
.mobile-drawer.open .drawer-panel{transform:translateX(0);}
.bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1.5px solid var(--border);padding:.42rem 0 calc(.42rem + env(safe-area-inset-bottom,0px));z-index:150;box-shadow:0 -2px 12px rgba(255,140,0,.12);}
.bottom-nav-inner{display:flex;justify-content:space-around;}
.bnav-btn{display:flex;flex-direction:column;align-items:center;gap:.15rem;background:none;border:none;cursor:pointer;padding:.28rem .7rem;color:var(--muted);font-family:'Noto Sans JP',sans-serif;font-size:.57rem;font-weight:700;min-width:58px;}
.bnav-btn .bi{font-size:1.18rem;}
.bnav-btn.active{color:var(--mango-dark);}
.asheet{position:fixed;inset:0;z-index:190;pointer-events:none;}
.asheet.open{pointer-events:auto;}
.asheet-back{position:absolute;inset:0;background:rgba(45,26,0,.45);opacity:0;transition:opacity .22s;}
.asheet.open .asheet-back{opacity:1;}
.asheet-panel{position:absolute;bottom:0;left:0;right:0;background:#fff;border-radius:16px 16px 0 0;padding:1.1rem 1rem calc(1.1rem + env(safe-area-inset-bottom,0px));transform:translateY(100%);transition:transform .24s cubic-bezier(.4,0,.2,1);}
.asheet.open .asheet-panel{transform:translateY(0);}
.asheet-handle{width:36px;height:4px;background:#ddd;border-radius:2px;margin:0 auto .85rem;}
.asheet-title{font-size:.63rem;font-weight:700;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:.55rem;}
.asheet-btn{display:flex;align-items:center;gap:.5rem;width:100%;background:var(--mango-light);border:none;color:var(--ink);padding:.52rem .75rem;border-radius:9px;cursor:pointer;font-family:'Noto Sans JP',sans-serif;font-size:.86rem;font-weight:700;margin-bottom:.35rem;}
.asheet-btn:hover{background:#ffe0b2;}
@media(max-width:700px){
  .mobile-topbar{display:flex;}
  .sidebar{display:none;}
  .main{padding:.85rem;padding-top:4.1rem;padding-bottom:5rem;}
  .bottom-nav{display:block;}
  .field-row.col2>*,.field-row.col3>*{min-width:100%;flex:none;width:100%;}
  .proc-header{grid-template-columns:1fr 58px 58px 62px;font-size:.59rem;}
  .proc-row{grid-template-columns:1fr 58px 58px 62px;}
  .proc-name{font-size:.77rem;}
  .proc-subtotal{font-size:.74rem;}
  .timer-display{font-size:2rem;letter-spacing:2px;}
  .timer-btns .btn{font-size:.73rem;padding:.4rem .65rem;}
  .gt-amount{font-size:1.35rem;}
  .worker-chip{font-size:.77rem;padding:.36rem .65rem;}
  .history-card-head{flex-wrap:wrap;gap:.4rem;padding:.65rem .82rem;}
  .history-amount{font-size:.86rem;}
  .month-summary{gap:.75rem;}
  .shift-day{font-size:.72rem;}
  .worker-grid{grid-template-columns:repeat(auto-fill,minmax(128px,1fr));}
  .modal-box{width:97vw;}
  .pw-box{padding:1.45rem;}
  .page-header h2{font-size:1.12rem;}
  .card{padding:.88rem .95rem;}
  .history-controls{flex-direction:column;gap:.45rem;}
  .print-overlay{padding:.6rem;}
  .print-actions{flex-direction:column;align-items:center;}
  .sync-toast{bottom:5rem;}
  .bonus-toggle{flex-wrap:nowrap;}
}
</style>
</head>
<body>
<!-- MOBILE TOPBAR -->
<div class="mobile-topbar">
  <div class="mobile-brand"><span class="mlogo">🥭</span>Global Mango</div>
  <button class="hamburger" id="hamburger" onclick="toggleDrawer()">
    <span></span><span></span><span></span>
  </button>
</div>
<!-- MOBILE DRAWER -->
<div class="mobile-drawer" id="mobile-drawer">
  <div class="drawer-backdrop" onclick="closeDrawer()"></div>
  <div class="drawer-panel">
    <div class="brand">
      <div class="brand-logo">🥭</div>
      <div class="brand-name">Global Mango</div>
      <div class="brand-sub">System</div>
      <div class="sync-info"><div class="sync-dot" id="sync-dot-m"></div><span id="sync-label-m">接続中...</span></div>
    </div>
    <div>
      <div class="nav-section">外注さん用</div>
      <button class="nav-btn active" id="drawer-submit" onclick="drawerNav('submit',this)"><span class="icon">✏️</span>作業を入力する</button>
      <button class="nav-btn" id="drawer-shift" onclick="drawerNav('shift',this)"><span class="icon">🗓</span>シフト希望を出す</button>
    </div>
    <div>
      <div class="nav-section">管理者用</div>
      <button class="nav-btn" onclick="drawerRequestPage('history');closeDrawer()"><span class="icon">📋</span>履歴・明細書<span class="lock-icon">🔒</span></button>
      <button class="nav-btn" onclick="drawerRequestPage('shift-admin');closeDrawer()"><span class="icon">📅</span>シフト管理<span class="lock-icon">🔒</span></button>
      <button class="nav-btn" onclick="drawerRequestPage('settings');closeDrawer()"><span class="icon">⚙️</span>設定<span class="lock-icon">🔒</span></button>
    </div>
    <div style="margin-top:auto;">
      <button class="btn btn-sm" onclick="forcePull();closeDrawer();" style="background:rgba(255,255,255,.15);color:#fff;border:none;width:100%;">🔄 今すぐ同期</button>
    </div>
  </div>
</div>
<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <div class="bottom-nav-inner">
    <button class="bnav-btn active" id="bnav-submit" onclick="showPage('submit',null);setBottomActive('submit')"><span class="bi">✏️</span>作業入力</button>
    <button class="bnav-btn" id="bnav-shift" onclick="showPage('shift',null);setBottomActive('shift')"><span class="bi">🗓</span>シフト希望</button>
    <button class="bnav-btn" id="bnav-admin" onclick="openAdminSheet()"><span class="bi">🔒</span>管理者</button>
  </div>
</div>
<!-- ADMIN BOTTOM SHEET -->
<div class="asheet" id="asheet">
  <div class="asheet-back" onclick="closeAdminSheet()"></div>
  <div class="asheet-panel">
    <div class="asheet-handle"></div>
    <div class="asheet-title">管理者メニュー 🔒</div>
    <button class="asheet-btn" onclick="drawerRequestPage('history');closeAdminSheet()"><span>📋</span>履歴・明細書</button>
    <button class="asheet-btn" onclick="drawerRequestPage('shift-admin');closeAdminSheet()"><span>📅</span>シフト管理</button>
    <button class="asheet-btn" onclick="drawerRequestPage('settings');closeAdminSheet()"><span>⚙️</span>設定</button>
  </div>
</div>
<div id="sync-bar"></div>
<div class="sync-toast" id="sync-toast"></div>
<div class="app-shell">

<aside class="sidebar">
  <div class="brand">
    <div class="brand-logo">🥭</div>
    <div class="brand-name">Global Mango</div>
    <div class="brand-sub">System</div>
    <div class="sync-info"><div class="sync-dot" id="sync-dot"></div><span id="sync-label">接続中...</span></div>
  </div>
  <div>
    <div class="nav-section">外注さん用</div>
    <button class="nav-btn active" onclick="showPage('submit',this)"><span class="icon">✏️</span>作業を入力する</button>
    <button class="nav-btn" onclick="showPage('shift',this)"><span class="icon">🗓</span>シフト希望を出す</button>
  </div>
  <div>
    <div class="nav-section">管理者用</div>
    <button class="nav-btn" onclick="requestPage('history',this)"><span class="icon">📋</span>履歴・明細書<span class="lock-icon">🔒</span></button>
    <button class="nav-btn" onclick="requestPage('shift-admin',this)"><span class="icon">📅</span>シフト管理<span class="lock-icon">🔒</span></button>
    <button class="nav-btn" onclick="requestPage('settings',this)"><span class="icon">⚙️</span>設定<span class="lock-icon">🔒</span></button>
  </div>
  <div style="margin-top:auto;display:flex;flex-direction:column;gap:.45rem;">
    <button class="btn btn-sm" onclick="forcePull()" style="background:rgba(255,255,255,.15);color:#fff;border:none;">🔄 今すぐ同期</button>
    <div style="font-size:.6rem;color:rgba(255,255,255,.32);line-height:1.7;">Global Mango System<br>データはクラウド保存</div>
  </div>
</aside>

<main class="main">

<!-- 外注さん：作業入力 -->
<div class="page active" id="page-submit">
  <div class="page-header"><h2>🥭 作業を入力する</h2><p>名前を選んで、今日の作業内容を入力して提出してください</p></div>

  <div class="card">
    <div class="card-head">👤 あなたは誰ですか？</div>
    <div class="worker-picker" id="worker-picker-submit"></div>
    <div class="field-row col2">
      <div class="field"><label>作業日</label><input type="date" id="work-date"></div>
      <div class="field"><label>住所（初回のみ）</label><input type="text" id="worker-address" placeholder="東京都〇〇区"></div>
    </div>
  </div>

  <div class="card timer-card no-print">
    <div class="card-head">⏱ 作業時間タイマー <span style="font-size:.56rem;opacity:.32;">税務資料用</span></div>
    <div class="timer-display" id="timer-display">00:00:00</div>
    <div class="timer-status" id="timer-status">待機中</div>
    <div class="timer-btns">
      <button class="btn btn-green" id="timer-start-btn" onclick="timerStart()">▶ 開始</button>
      <button class="btn btn-sm" id="timer-pause-btn" onclick="timerPause()" style="background:rgba(255,255,255,.1);color:var(--yellow);border:1px solid rgba(255,255,255,.18);" disabled>⏸ 休憩</button>
      <button class="btn btn-sm" onclick="timerReset()" style="background:rgba(255,255,255,.07);color:rgba(255,255,255,.45);border:1px solid rgba(255,255,255,.1);">↺ リセット</button>
      <button class="btn btn-primary btn-sm" onclick="timerApply()">✓ 時間を反映</button>
    </div>
    <div class="timer-log">
      <div class="timer-log-title">作業ログ</div>
      <div class="timer-log-list" id="timer-log-list"><div style="color:rgba(255,255,255,.2);font-size:.7rem;">開始すると記録されます</div></div>
      <div class="timer-total-row"><span>作業合計</span><span id="timer-total-display">0時間00分</span></div>
    </div>
  </div>

  <div class="card">
    <div class="card-head">📦 加工内容</div>
    <div class="proc-header"><span>種別</span><span style="text-align:center;">単価</span><span style="text-align:center;">個数</span><span style="text-align:right;">小計</span></div>
    <div id="proc-list"></div>
  </div>

  <div class="card">
    <div class="card-head">🕐 会議・他業務</div>
    <div class="proc-header"><span>種別</span><span style="text-align:center;">時給</span><span style="text-align:center;">時間数</span><span style="text-align:right;">小計</span></div>
    <div class="proc-row" id="hourly-row">
      <div><span class="proc-name">会議 / 他業務</span></div>
      <div style="text-align:center;font-family:'DM Mono',monospace;font-size:.82rem;color:var(--muted);">¥1,200</div>
      <input type="number" id="hourly-hours" min="0" step="0.5" value="0" oninput="calculate()">
      <span class="proc-subtotal" id="hourly-sub">¥0</span>
    </div>
  </div>

  <div style="display:flex;align-items:center;gap:.7rem;flex-wrap:wrap;margin-bottom:.85rem;">
    <div class="bonus-toggle no-print" id="bonus-toggle" onclick="toggleBonus()" style="flex:1;min-width:215px;margin-bottom:0;">
      <div class="tog-switch"></div>
      <div class="tog-text"><div class="tog-main" id="bonus-label">＋10% 上乗せ</div><div class="tog-sub">最終金額に上乗せ（対象者のみ）</div></div>
    </div>
    <div class="bonus-rate-field no-print">
      <span style="font-size:.7rem;color:var(--muted);font-weight:700;">率：</span>
      <input type="number" id="bonus-rate-input" value="10" min="1" max="100" step="1" style="width:52px;text-align:center;font-family:'DM Mono',monospace;" oninput="updateBonusRate()">
      <span style="font-size:.86rem;">%</span>
    </div>
  </div>

  <div class="card total-card">
    <div class="card-head">💴 合計金額</div>
    <div id="breakdown-rows"></div>
    <hr class="total-sep">
    <div class="grand-total"><span class="gt-label">今回合計</span><span class="gt-amount" id="grand-total-display">¥0</span></div>
  </div>

  <div class="card">
    <div class="card-head">📝 備考・メモ</div>
    <textarea id="remarks" placeholder="特記事項があれば入力してください"></textarea>
  </div>

  <div class="btn-group no-print">
    <button class="btn btn-primary" id="save-btn" onclick="saveRecord(event)" style="font-size:.93rem;padding:.68rem 1.45rem;">📨 提出する</button>
    <button class="btn btn-secondary" onclick="resetForm()">🔄 リセット</button>
  </div>
</div>

<!-- 外注さん：シフト -->
<div class="page" id="page-shift">
  <div class="page-header"><h2>🗓 シフト希望を出す</h2><p>来月の出勤希望日を選んで提出してください</p></div>
  <div class="card shift-card">
    <div class="card-head">👤 お名前を選んでください</div>
    <select id="shift-worker-select" style="width:100%;padding:.62rem .82rem;border-radius:8px;border:1.5px solid rgba(255,255,255,.22);background:rgba(255,255,255,.12);color:#fff;font-size:.93rem;font-family:'Noto Sans JP',sans-serif;margin-bottom:1.1rem;">
      <option value="">-- 名前を選ぶ --</option>
    </select>
    <div class="shift-month-nav">
      <button onclick="shiftCalPrev()">◀</button>
      <span class="shift-month-title" id="shift-cal-title"></span>
      <button onclick="shiftCalNext()">▶</button>
    </div>
    <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-bottom:.38rem;">
      <div class="shift-cal-head sun">日</div><div class="shift-cal-head">月</div><div class="shift-cal-head">火</div><div class="shift-cal-head">水</div><div class="shift-cal-head">木</div><div class="shift-cal-head">金</div><div class="shift-cal-head sat">土</div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:3px;" id="shift-cal"></div>
    <div style="margin-top:.95rem;padding-top:.95rem;border-top:1px solid rgba(255,255,255,.13);">
      <div style="font-size:.73rem;color:rgba(255,255,255,.48);margin-bottom:.42rem;">選択した日：<span id="shift-selected-count" style="color:#fff;font-weight:700;">0日</span></div>
      <div style="font-size:.68rem;color:rgba(255,255,255,.32);margin-bottom:.75rem;" id="shift-selected-list"></div>
      <button class="btn" style="width:100%;background:#fff;color:var(--mango-dark);font-size:.93rem;padding:.7rem;" onclick="submitShift()">✅ 希望を提出する</button>
    </div>
  </div>
  <div id="shift-submit-result" style="margin-top:.7rem;"></div>
</div>

<!-- 管理者：履歴 -->
<div class="page" id="page-history">
  <div class="page-header"><h2>📋 履歴・明細書</h2><p>提出された記録の確認・承認・明細書の発行</p></div>
  <div class="history-controls no-print">
    <div class="field" style="min-width:145px;"><label>月で絞り込み</label><input type="month" id="filter-month"></div>
    <div class="field" style="min-width:145px;"><label>名前で絞り込み</label><select id="filter-worker"><option value="">全員</option></select></div>
    <div style="margin-top:auto;display:flex;gap:.45rem;">
      <button class="btn btn-primary" onclick="openPrintPreview()">🖨 月次明細書</button>
      <button class="btn btn-secondary" onclick="exportCSV()">📊 CSV</button>
    </div>
  </div>
  <div id="month-summary-area"></div>
  <div id="history-list"></div>
</div>

<!-- 管理者：シフト管理 -->
<div class="page" id="page-shift-admin">
  <div class="page-header"><h2>📅 シフト管理</h2><p>希望を確認・承認・却下できます</p></div>
  <div class="card">
    <div class="card-head">カレンダー</div>
    <div class="shift-month-nav" style="margin-bottom:.45rem;">
      <button onclick="adminCalPrev()">◀</button>
      <span style="font-weight:700;" id="admin-cal-title"></span>
      <button onclick="adminCalNext()">▶</button>
    </div>
    <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:.28rem;">
      <div class="shift-admin-head" style="color:#ef4444;">日</div><div class="shift-admin-head">月</div><div class="shift-admin-head">火</div><div class="shift-admin-head">水</div><div class="shift-admin-head">木</div><div class="shift-admin-head">金</div><div class="shift-admin-head" style="color:#3b82f6;">土</div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;" id="admin-cal"></div>
  </div>
  <div class="card">
    <div class="card-head">一覧</div>
    <div style="display:flex;gap:.45rem;flex-wrap:wrap;margin-bottom:.7rem;">
      <select id="shift-filter-worker" style="padding:.38rem .62rem;border-radius:6px;border:1px solid var(--border);font-size:.8rem;"><option value="">全員</option></select>
      <select id="shift-filter-status" style="padding:.38rem .62rem;border-radius:6px;border:1px solid var(--border);font-size:.8rem;">
        <option value="">全ステータス</option><option value="pending">未確認</option><option value="approved">承認済み</option><option value="rejected">却下</option>
      </select>
      <button class="btn btn-secondary btn-sm" onclick="renderShiftAdmin()">絞り込み</button>
    </div>
    <div id="shift-admin-list"></div>
  </div>
</div>

<!-- 管理者：設定 -->
<div class="page" id="page-settings">
  <div class="page-header"><h2>⚙️ 設定</h2><p>会社情報・外注さん管理・単価・パスワード</p></div>
  <div class="card">
    <div class="card-head">🔒 管理者パスワード</div>
    <div class="field-row col2">
      <div class="field"><label>新しいパスワード</label><input type="password" id="setting-pw-new"></div>
      <div class="field"><label>確認（再入力）</label><input type="password" id="setting-pw-confirm"></div>
    </div>
    <button class="btn btn-primary" style="margin-top:.5rem;" onclick="changeAdminPassword(event)">パスワードを変更</button>
  </div>
  <div class="card">
    <div class="card-head">🏢 会社情報</div>
    <div class="field-row col2">
      <div class="field"><label>会社名・屋号</label><input type="text" id="setting-company"></div>
      <div class="field"><label>担当者名（任意）</label><input type="text" id="setting-manager" placeholder="例：田中 太郎"></div>
    </div>
    <div class="field-row"><div class="field"><label>住所（任意）</label><input type="text" id="setting-address" placeholder="例：東京都渋谷区〇〇 1-2-3"></div></div>
    <button class="btn btn-primary" style="margin-top:.5rem;" onclick="saveCompanySettings(event)">設定を保存</button>
  </div>
  <div class="card">
    <div class="card-head">🏦 自社（振込元）口座</div>
    <div class="field-row col2">
      <div class="field"><label>銀行名</label><input type="text" id="setting-bank-name" placeholder="〇〇銀行"></div>
      <div class="field"><label>支店名</label><input type="text" id="setting-bank-branch" placeholder="〇〇支店"></div>
    </div>
    <div class="field-row col3">
      <div class="field"><label>口座種別</label><select id="setting-bank-type"><option value="普通">普通</option><option value="当座">当座</option></select></div>
      <div class="field"><label>口座番号</label><input type="text" id="setting-bank-number" placeholder="1234567" style="font-family:'DM Mono',monospace;"></div>
      <div class="field"><label>口座名義（カナ）</label><input type="text" id="setting-bank-holder" placeholder="グローバルマンゴー"></div>
    </div>
    <button class="btn btn-primary" style="margin-top:.5rem;" onclick="saveCompanySettings(event)">保存</button>
  </div>
  <div class="card">
    <div class="card-head">💹 上乗せ率デフォルト</div>
    <div class="field-row col2">
      <div class="field"><label>デフォルト上乗せ率（%）</label>
        <div style="display:flex;align-items:center;gap:.45rem;"><input type="number" id="setting-bonus-rate" min="1" max="100" value="10" style="width:95px;"><span style="font-size:.86rem;color:var(--muted);">%</span></div>
      </div>
    </div>
    <button class="btn btn-primary" style="margin-top:.5rem;" onclick="saveBonusRateSetting(event)">保存</button>
  </div>
  <div class="card">
    <div class="card-head">👤 外注さん登録・管理</div>
    <div class="worker-grid" id="worker-settings-list"></div>
    <div style="border-top:1px solid var(--border);padding-top:.8rem;">
      <button class="btn btn-green" onclick="openWorkerModal(-1)">＋ 新しい外注さんを追加</button>
    </div>
  </div>
  <div class="card">
    <div class="card-head">📦 加工オプション管理</div>
    <div id="price-settings-list" style="display:flex;flex-direction:column;gap:.32rem;margin-bottom:.7rem;"></div>
    <div style="border-top:1px solid var(--border);padding-top:.7rem;">
      <div style="font-size:.65rem;font-weight:700;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:.42rem;">＋ 新しいオプションを追加</div>
      <div class="field-row col2">
        <div class="field"><label>オプション名</label><input type="text" id="new-proc-name" placeholder="例：ラベル貼り"></div>
        <div class="field"><label>単価（円）</label><input type="number" id="new-proc-price" min="1" placeholder="30"></div>
      </div>
      <button class="btn btn-green" onclick="addProcess()" style="margin-top:.4rem;">＋ 追加</button>
    </div>
    <button class="btn btn-primary" style="margin-top:.7rem;" id="save-prices-btn" onclick="savePrices(event)">単価を保存</button>
  </div>
</div>

</main>
</div>

<!-- PASSWORD MODAL -->
<div class="pw-overlay hidden" id="pw-modal">
  <div class="pw-box">
    <h3>🔒 管理者認証</h3>
    <p id="pw-modal-desc">管理者パスワードを入力してください。</p>
    <input type="password" id="pw-input" placeholder="パスワード" maxlength="50" onkeydown="if(event.key==='Enter')pwSubmit()">
    <div class="pw-error" id="pw-error"></div>
    <div class="pw-btns">
      <button class="btn btn-secondary" style="flex:1;" onclick="pwCancel()">キャンセル</button>
      <button class="btn btn-primary" style="flex:1;" onclick="pwSubmit()">🔓 認証する</button>
    </div>
  </div>
</div>

<!-- WORKER MODAL -->
<div class="modal-overlay hidden" id="worker-modal">
  <div class="modal-box">
    <div class="modal-header">
      <h3 id="modal-title">外注さんを編集</h3>
      <button class="modal-close" onclick="closeWorkerModal()">✕</button>
    </div>
    <div class="modal-body">
      <div class="modal-section">基本情報</div>
      <div class="modal-avatar-row">
        <label class="avatar-upload">
          <div class="avatar-upload-ring" id="modal-avatar-ring">📷</div>
          <input type="file" accept="image/*" onchange="previewModalAvatar(event)">
        </label>
        <div style="flex:1;">
          <div class="field-row col2">
            <div class="field"><label>名前</label><input type="text" id="modal-worker-name" placeholder="山田 花子"></div>
            <div class="field"><label>住所</label><input type="text" id="modal-worker-addr" placeholder="東京都〇〇区"></div>
          </div>
        </div>
      </div>
      <div class="modal-section">🏦 振込先口座（任意）</div>
      <div class="bank-box" style="margin-top:0;">
        <div class="bank-grid">
          <div class="bank-field"><label>銀行名</label><input type="text" id="modal-bank-name" placeholder="〇〇銀行"></div>
          <div class="bank-field"><label>支店名</label><input type="text" id="modal-bank-branch" placeholder="〇〇支店"></div>
          <div class="bank-field"><label>口座種別</label><select id="modal-bank-type"><option value="普通">普通</option><option value="当座">当座</option></select></div>
          <div class="bank-field"><label>口座番号</label><input type="text" id="modal-bank-number" placeholder="1234567" style="font-family:'DM Mono',monospace;"></div>
        </div>
        <div class="bank-field" style="margin-top:.38rem;"><label>口座名義（カナ）</label><input type="text" id="modal-bank-holder" placeholder="ヤマダ ハナコ"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeWorkerModal()">キャンセル</button>
      <button class="btn btn-primary" onclick="saveWorkerModal()">💾 保存する</button>
    </div>
  </div>
</div>

<!-- PRINT OVERLAY -->
<div class="print-overlay no-print" id="print-overlay">
  <div style="width:100%;max-width:230mm;">
    <div class="print-actions">
      <button class="btn btn-primary" onclick="doPrint()">🖨 印刷する</button>
      <button class="btn btn-secondary" onclick="closePrint()">✕ 閉じる</button>
    </div>
    <div id="print-doc"></div>
  </div>
</div>

<script>
const PROXY_URL='/.netlify/functions/jsonbin';
const DEFAULT_PROCESSES=[
  {id:'box',name:'箱に入れる',price:50},{id:'waterproof',name:'防水袋/プチプチ',price:10},
  {id:'roll',name:'プチプチロール',price:30},{id:'compress',name:'圧縮',price:70},
  {id:'boxwork',name:'箱加工（通常）',price:100},{id:'boxlarge',name:'箱加工（特大）',price:200},
  {id:'set',name:'セット梱包',price:50},{id:'danboru',name:'巻段ボール',price:50},
  {id:'label',name:'発送伝票打ち込み',price:50},
];
const HOURLY_RATE=1200;

let processes=DEFAULT_PROCESSES.slice(),workers=[],records=[],shifts=[];
let settings={company:'Global Mango System',manager:'',address:'',bonusRate:10,
  bankName:'',bankBranch:'',bankType:'普通',bankNumber:'',bankHolder:'',adminPw:'1234'};
let bonusOn=false,bonusRate=10,isSyncing=false;
let timerInterval=null,timerRunning=false,timerElapsed=0,timerSessionStart=null,timerLog=[];
let adminUnlocked=false,pwPendingPage=null,pwPendingBtn=null;
let modalWorkerIndex=-1,modalAvatarData=null;
let shiftCalYear=new Date().getFullYear(),shiftCalMonth=new Date().getMonth()+2;
let shiftSelectedDays=new Set();
let adminCalYear=new Date().getFullYear(),adminCalMonth=new Date().getMonth()+1;

// ── SYNC ──
async function pushData(){
  if(isSyncing)return;isSyncing=true;setSyncBar('loading');
  try{
    const res=await fetch(PROXY_URL,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({records,workers,settings,processes,shifts,_updatedAt:new Date().toISOString()})});
    if(!res.ok)throw new Error('HTTP '+res.status);
    setSyncBar('ok');showToast('✅ 同期しました');
  }catch(e){setSyncBar('err');showToast('❌ '+e.message);}
  finally{isSyncing=false;}
}
async function pullData(){
  setSyncBar('loading');
  try{
    const res=await fetch(PROXY_URL,{method:'GET'});
    if(!res.ok)throw new Error('HTTP '+res.status);
    const d=await res.json();
    if(d.records)records=d.records;
    if(d.workers)workers=d.workers;
    if(d.settings)settings={...settings,...d.settings};
    if(d.processes)processes=d.processes;
    if(d.shifts)shifts=d.shifts;
    bonusRate=settings.bonusRate||10;
    setSyncBar('ok');
    document.getElementById('sync-dot').classList.remove('offline');
    document.getElementById('sync-label').textContent='同期済み';
    updateSyncMobile('ok','同期済み');
  }catch(e){
    setSyncBar('err');
    document.getElementById('sync-dot').classList.add('offline');
    document.getElementById('sync-label').textContent='オフライン';
    updateSyncMobile('offline','オフライン');
    showToast('❌ 接続失敗');
  }
}
async function forcePull(){await pullData();initApp();}
function setSyncBar(s){const b=document.getElementById('sync-bar');b.className=s;if(s==='ok')setTimeout(()=>b.className='',2000);}
function showToast(msg){const t=document.getElementById('sync-toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}

// ── NAV ──
function showPage(id,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  if(btn)btn.classList.add('active');
  if(id==='shift')initShiftPage();
  if(id==='shift-admin')initShiftAdmin();
  if(id==='history')renderHistory();
  if(id==='settings'){loadCompanySettings();renderSettingsWorkers();renderPriceSettings();}
}
function requestPage(id,btn){
  if(adminUnlocked){showPage(id,btn);return;}
  pwPendingPage=id;pwPendingBtn=btn;
  const desc={history:'履歴・明細書',settings:'設定','shift-admin':'シフト管理'};
  document.getElementById('pw-modal-desc').textContent=(desc[id]||id)+'ページへのアクセスには管理者パスワードが必要です。';
  document.getElementById('pw-input').value='';document.getElementById('pw-error').textContent='';
  document.getElementById('pw-modal').classList.remove('hidden');
  setTimeout(()=>document.getElementById('pw-input').focus(),80);
}

// ── PASSWORD ──
function pwSubmit(){
  const entered=document.getElementById('pw-input').value;
  if(entered===(settings.adminPw||'1234')){
    adminUnlocked=true;document.getElementById('pw-modal').classList.add('hidden');
    document.querySelectorAll('.lock-icon').forEach(el=>el.style.opacity='0');
    if(pwPendingPage){showPage(pwPendingPage,pwPendingBtn);pwPendingPage=null;pwPendingBtn=null;}
  }else{
    document.getElementById('pw-error').textContent='❌ パスワードが違います';
    document.getElementById('pw-input').value='';document.getElementById('pw-input').focus();
  }
}
function pwCancel(){document.getElementById('pw-modal').classList.add('hidden');pwPendingPage=null;pwPendingBtn=null;}
async function changeAdminPassword(e){
  const nw=document.getElementById('setting-pw-new').value;
  const cf=document.getElementById('setting-pw-confirm').value;
  if(!nw){alert('新しいパスワードを入力してください');return;}
  if(nw!==cf){alert('パスワードが一致しません');return;}
  if(nw.length<4){alert('4文字以上で設定してください');return;}
  settings.adminPw=nw;
  document.getElementById('setting-pw-new').value='';document.getElementById('setting-pw-confirm').value='';
  const btn=e.currentTarget;btn.textContent='⏳ 保存中...';btn.disabled=true;
  await pushData();btn.textContent='✅ 変更しました';
  setTimeout(()=>{btn.textContent='パスワードを変更';btn.disabled=false;},1800);
}

// ── WORKER PICKER ──
function buildWorkerPicker(){
  const el=document.getElementById('worker-picker-submit');if(!el)return;
  if(!workers.length){el.innerHTML='<div style="color:var(--muted);font-size:.83rem;">設定ページで外注さんを登録してください</div>';return;}
  el.innerHTML=workers.map((w,i)=>`
    <div class="worker-chip" id="chip-${i}" onclick="selectWorker(${i},this)">
      ${w.avatar?`<img src="${w.avatar}" class="avatar">`:`<div class="avatar-placeholder">${(w.name||'?').charAt(0).toUpperCase()}</div>`}
      ${w.name}
    </div>`).join('');
}
function selectWorker(i,el){
  document.querySelectorAll('.worker-chip').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('worker-address').value=workers[i].address||'';
}
function getSelectedWorker(){
  const chip=document.querySelector('.worker-chip.selected');
  if(!chip)return null;
  return workers[parseInt(chip.id.replace('chip-',''))]||null;
}

// ── PROC ──
function buildProcList(){
  const el=document.getElementById('proc-list');el.innerHTML='';
  processes.forEach(p=>{
    const row=document.createElement('div');row.className='proc-row';row.id='proc-row-'+p.id;
    row.innerHTML=`<div><span class="proc-name">${p.name}</span></div>
      <div style="text-align:center;font-family:'DM Mono',monospace;font-size:.82rem;color:var(--muted);">¥${p.price.toLocaleString()}</div>
      <input type="number" id="qty-${p.id}" min="0" step="1" value="0" oninput="calculate()">
      <span class="proc-subtotal" id="sub-${p.id}">¥0</span>`;
    el.appendChild(row);
  });
}

// ── CALCULATE ──
function calculate(){
  let items=[],baseTotal=0;
  processes.forEach(p=>{
    const qty=parseInt(document.getElementById('qty-'+p.id)?.value)||0;
    const sub=qty*p.price;
    const sEl=document.getElementById('sub-'+p.id),rEl=document.getElementById('proc-row-'+p.id);
    if(sEl){sEl.textContent='¥'+sub.toLocaleString();sEl.className='proc-subtotal'+(sub>0?' active':'');}
    if(rEl)rEl.classList.toggle('has-value',qty>0);
    if(qty>0)items.push({name:p.name,price:p.price,qty,sub});
    baseTotal+=sub;
  });
  const hours=parseFloat(document.getElementById('hourly-hours')?.value)||0;
  const hSub=Math.round(hours*HOURLY_RATE);
  const hEl=document.getElementById('hourly-sub'),hRow=document.getElementById('hourly-row');
  if(hEl){hEl.textContent='¥'+hSub.toLocaleString();hEl.className='proc-subtotal'+(hSub>0?' active':'');}
  if(hRow)hRow.classList.toggle('has-value',hours>0);
  if(hours>0)items.push({name:`会議・他業務(${hours}h)`,price:HOURLY_RATE,qty:hours,sub:hSub,isHourly:true});
  baseTotal+=hSub;
  const bonusAmt=bonusOn?Math.round(baseTotal*(bonusRate/100)):0;
  const total=baseTotal+bonusAmt;
  const bd=document.getElementById('breakdown-rows');bd.innerHTML='';
  if(!items.length){bd.innerHTML='<div class="total-row" style="color:rgba(255,255,255,.32);">（加工内容を入力してください）</div>';}
  else{
    items.forEach(it=>{
      const r=document.createElement('div');r.className='total-row';
      r.innerHTML=`<span>${it.name} <span style="font-size:.72rem;opacity:.52;">${it.isHourly?it.qty+'h':it.qty+'個'} × ¥${it.price.toLocaleString()}</span></span><span>¥${it.sub.toLocaleString()}</span>`;
      bd.appendChild(r);
    });
    if(bonusOn&&bonusAmt>0){
      const s=document.createElement('hr');s.className='total-sep';bd.appendChild(s);
      [{txt:'小計',v:baseTotal},{txt:`＋${bonusRate}% 上乗せ`,v:bonusAmt}].forEach(x=>{
        const r=document.createElement('div');r.className='total-row bold';
        r.innerHTML=`<span>${x.txt}</span><span>¥${x.v.toLocaleString()}</span>`;bd.appendChild(r);
      });
    }
  }
  document.getElementById('grand-total-display').textContent='¥'+total.toLocaleString();
  return{items,baseTotal,bonusAmt,total};
}
function toggleBonus(){bonusOn=!bonusOn;document.getElementById('bonus-toggle').classList.toggle('on',bonusOn);calculate();}
function updateBonusRate(){
  const v=parseInt(document.getElementById('bonus-rate-input')?.value)||10;
  bonusRate=Math.max(1,Math.min(100,v));
  document.getElementById('bonus-label').textContent=`＋${bonusRate}% 上乗せ`;calculate();
}

// ── SAVE (外注さんが提出) ──
async function saveRecord(e){
  const w=getSelectedWorker();if(!w){alert('名前を選んでください');return;}
  const date=document.getElementById('work-date').value;if(!date){alert('作業日を入力してください');return;}
  const{items,baseTotal,bonusAmt,total}=calculate();
  const address=document.getElementById('worker-address').value.trim();
  const remarks=document.getElementById('remarks').value.trim();
  if(address)w.address=address;
  records.unshift({
    id:Date.now(),date,name:w.name,address:address||w.address||'',remarks,avatar:w.avatar||null,
    bonusOn,bonusAmt,bonusRate,items,baseTotal,total,
    hours:parseFloat(document.getElementById('hourly-hours').value)||0,
    timerLog:[...timerLog],timerWorkMs:timerElapsed,
    status:'pending',createdAt:new Date().toLocaleString('ja-JP')
  });
  if(records.length>500)records=records.slice(0,500);
  const btn=e.currentTarget;btn.textContent='⏳ 提出中...';btn.disabled=true;
  await pushData();
  btn.textContent='✅ 提出しました！';
  setTimeout(()=>{btn.textContent='📨 提出する';btn.disabled=false;},2000);
  resetForm();
}
function resetForm(){
  processes.forEach(p=>{const el=document.getElementById('qty-'+p.id);if(el)el.value=0;});
  document.getElementById('hourly-hours').value=0;
  document.getElementById('remarks').value='';
  bonusOn=false;document.getElementById('bonus-toggle').classList.remove('on');
  document.querySelectorAll('.worker-chip').forEach(c=>c.classList.remove('selected'));
  timerRunning=false;clearInterval(timerInterval);timerElapsed=0;timerSessionStart=null;timerLog=[];
  document.getElementById('timer-display').textContent='00:00:00';
  document.getElementById('timer-status').textContent='待機中';
  document.getElementById('timer-status').className='timer-status';
  document.getElementById('timer-start-btn').disabled=false;
  document.getElementById('timer-pause-btn').disabled=true;
  document.getElementById('timer-log-list').innerHTML='<div style="color:rgba(255,255,255,.2);font-size:.7rem;">開始すると記録されます</div>';
  document.getElementById('timer-total-display').textContent='0時間00分';
  calculate();
}

// ── TIMER ──
function timerTick(){
  const t=timerElapsed+(Date.now()-timerSessionStart);
  const h=Math.floor(t/3600000),m=Math.floor((t%3600000)/60000),s=Math.floor((t%60000)/1000);
  document.getElementById('timer-display').textContent=String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
}
function timerStart(){
  if(timerRunning)return;timerRunning=true;timerSessionStart=Date.now();
  timerInterval=setInterval(timerTick,500);
  timerLog.push({type:timerElapsed===0?'開始':'再開',time:new Date()});renderTimerLog();
  document.getElementById('timer-status').textContent='作業中';document.getElementById('timer-status').className='timer-status running';
  document.getElementById('timer-start-btn').disabled=true;document.getElementById('timer-pause-btn').disabled=false;
}
function timerPause(){
  if(!timerRunning)return;timerRunning=false;timerElapsed+=Date.now()-timerSessionStart;clearInterval(timerInterval);
  timerLog.push({type:'休憩',time:new Date()});renderTimerLog();
  document.getElementById('timer-status').textContent='休憩中';document.getElementById('timer-status').className='timer-status paused';
  document.getElementById('timer-start-btn').disabled=false;document.getElementById('timer-pause-btn').disabled=true;
}
function timerReset(){
  if(!confirm('タイマーをリセットしますか？'))return;
  timerRunning=false;clearInterval(timerInterval);timerElapsed=0;timerSessionStart=null;timerLog=[];
  document.getElementById('timer-display').textContent='00:00:00';
  document.getElementById('timer-status').textContent='待機中';document.getElementById('timer-status').className='timer-status';
  document.getElementById('timer-start-btn').disabled=false;document.getElementById('timer-pause-btn').disabled=true;
  document.getElementById('timer-log-list').innerHTML='<div style="color:rgba(255,255,255,.2);font-size:.7rem;">開始すると記録されます</div>';
  document.getElementById('timer-total-display').textContent='0時間00分';
}
function timerApply(){
  if(timerRunning)timerPause();
  if(timerElapsed===0){alert('タイマーを開始してください');return;}
  timerLog.push({type:'終了',time:new Date()});renderTimerLog();
  const workMs=timerElapsed;let breakMs=0,lastPause=null;
  timerLog.forEach(l=>{if(l.type==='休憩')lastPause=l.time;if((l.type==='再開'||l.type==='終了')&&lastPause){breakMs+=new Date(l.time)-new Date(lastPause);lastPause=null;}});
  const rounded=Math.round((workMs/3600000)*2)/2;
  document.getElementById('hourly-hours').value=rounded;calculate();
  const wh=Math.floor(workMs/3600000),wm=Math.floor((workMs%3600000)/60000);
  const bh=Math.floor(breakMs/3600000),bm=Math.floor((breakMs%3600000)/60000);
  const logText=timerLog.map(l=>`[${new Date(l.time).toLocaleTimeString('ja-JP')}] ${l.type}`).join('\n');
  const ex=document.getElementById('remarks').value;
  document.getElementById('remarks').value=(ex?ex+'\n':'')+'【作業ログ】\n'+logText+'\n作業：'+wh+'時間'+String(wm).padStart(2,'0')+'分 / 休憩：'+bh+'時間'+String(bm).padStart(2,'0')+'分';
  document.getElementById('timer-status').textContent=`反映済み（${rounded}時間）`;document.getElementById('timer-status').className='timer-status';
  document.getElementById('timer-start-btn').disabled=true;
}
function renderTimerLog(){
  const el=document.getElementById('timer-log-list');
  el.innerHTML=timerLog.map(l=>`<div class="timer-log-item"><span>${new Date(l.time).toLocaleTimeString('ja-JP')}</span><span>${l.type}</span></div>`).join('');
  el.scrollTop=el.scrollHeight;
  const t=timerElapsed+(timerRunning?Date.now()-timerSessionStart:0);
  document.getElementById('timer-total-display').textContent=Math.floor(t/3600000)+'時間'+String(Math.floor((t%3600000)/60000)).padStart(2,'0')+'分';
}

// ── HISTORY ──
function renderHistory(){
  const month=document.getElementById('filter-month')?.value||'';
  const wf=document.getElementById('filter-worker')?.value||'';
  const fw=document.getElementById('filter-worker');
  if(fw){const cur=fw.value;fw.innerHTML='<option value="">全員</option>'+[...new Set(records.map(r=>r.name))].map(n=>`<option value="${n}">${n}</option>`).join('');fw.value=cur;}
  let list=records;
  if(month)list=list.filter(r=>r.date.startsWith(month));
  if(wf)list=list.filter(r=>r.name===wf);
  const sa=document.getElementById('month-summary-area');
  if(month&&list.length){
    const tp=list.reduce((a,r)=>a+r.total,0);
    const names=[...new Set(list.map(r=>r.name))];
    const pending=list.filter(r=>r.status!=='approved').length;
    sa.innerHTML=`<div class="month-summary">
      <div class="ms-item"><div class="ms-label">合計支払額</div><div class="ms-val">¥${tp.toLocaleString()}</div></div>
      <div class="ms-item"><div class="ms-label">記録件数</div><div class="ms-val">${list.length}件</div></div>
      <div class="ms-item"><div class="ms-label">外注さん</div><div class="ms-val">${names.length}名</div></div>
      <div class="ms-item"><div class="ms-label">未承認</div><div class="ms-val" style="color:${pending>0?'var(--mango-dark)':'var(--green)'};">${pending}件</div></div>
    </div>`;
  }else{sa.innerHTML='';}
  const el=document.getElementById('history-list');
  if(!list.length){el.innerHTML='<div style="color:var(--muted);font-size:.84rem;padding:.8rem 0;">記録がありません</div>';return;}
  el.innerHTML=list.map(r=>{
    const badge=r.status==='approved'?'<span class="history-status status-approved">承認済み</span>':
      r.status==='rejected'?'<span class="history-status status-rejected">却下</span>':
      '<span class="history-status status-pending">未確認</span>';
    const aBtn=adminUnlocked&&r.status!=='approved'?`<button class="btn btn-green btn-sm" onclick="event.stopPropagation();approveRecord(${r.id})">✓ 承認</button>`:'';
    const rBtn=adminUnlocked&&r.status!=='rejected'?`<button class="btn btn-sm" style="background:var(--red-light);color:var(--red);border:1px solid #ef9a9a;" onclick="event.stopPropagation();rejectRecord(${r.id})">✕ 却下</button>`:'';
    const dBtn=adminUnlocked?`<button class="icon-btn" onclick="event.stopPropagation();deleteRecord(${r.id})" style="color:var(--red);">🗑</button>`:'';
    return`<div class="history-card">
      <div class="history-card-head" onclick="toggleDetail(${r.id})">
        ${r.avatar?`<img src="${r.avatar}" class="avatar">`:`<div class="avatar-placeholder">${(r.name||'?').charAt(0).toUpperCase()}</div>`}
        <div class="history-meta"><div class="history-name">${r.name} ${badge}</div><div class="history-date">${r.date}／${r.createdAt}</div></div>
        <div class="history-amount">¥${r.total.toLocaleString()}</div>
        <div style="display:flex;gap:.28rem;margin-left:.4rem;">${aBtn}${rBtn}${dBtn}</div>
        <span style="font-size:.78rem;color:var(--muted);margin-left:.28rem;">▼</span>
      </div>
      <div class="detail-panel" id="detail-${r.id}">
        <table class="detail-table"><thead><tr><th>加工の種類</th><th>単価</th><th>数量</th><th class="num">小計</th></tr></thead>
        <tbody>${r.items.map(it=>`<tr><td>${it.name}</td><td>¥${it.price.toLocaleString()}</td><td>${it.isHourly?it.qty+'h':it.qty+'個'}</td><td class="num">¥${it.sub.toLocaleString()}</td></tr>`).join('')}
        ${r.bonusOn?`<tr><td>＋${r.bonusRate||10}%上乗せ</td><td></td><td></td><td class="num">¥${r.bonusAmt.toLocaleString()}</td></tr>`:''}
        <tr style="font-weight:700;background:var(--mango-light);"><td colspan="3">合計</td><td class="num">¥${r.total.toLocaleString()}</td></tr>
        </tbody></table>
        ${r.remarks?`<div style="font-size:.77rem;color:var(--muted);white-space:pre-wrap;margin-bottom:.5rem;">備考：${r.remarks}</div>`:''}
        <button class="btn btn-secondary btn-sm" onclick="printSingle(${r.id})">🖨 印刷</button>
      </div>
    </div>`;
  }).join('');
}
function toggleDetail(id){document.getElementById('detail-'+id)?.classList.toggle('open');}
async function approveRecord(id){const r=records.find(x=>x.id===id);if(!r)return;r.status='approved';renderHistory();await pushData();}
async function rejectRecord(id){const r=records.find(x=>x.id===id);if(!r)return;r.status='rejected';renderHistory();await pushData();}
async function deleteRecord(id){if(!confirm('削除しますか？'))return;records=records.filter(r=>r.id!==id);await pushData();renderHistory();}

// ── SETTINGS ──
function loadCompanySettings(){
  document.getElementById('setting-company').value=settings.company||'Global Mango System';
  document.getElementById('setting-manager').value=settings.manager||'';
  document.getElementById('setting-address').value=settings.address||'';
  ['bank-name','bank-branch','bank-type','bank-number','bank-holder'].forEach(k=>{
    const el=document.getElementById('setting-'+k);
    if(el)el.value=settings[k.replace(/-([a-z])/g,(_,c)=>c.toUpperCase())]||'';
  });
  bonusRate=settings.bonusRate||10;
  const ri=document.getElementById('setting-bonus-rate');if(ri)ri.value=bonusRate;
  const bi=document.getElementById('bonus-rate-input');if(bi)bi.value=bonusRate;
  const bl=document.getElementById('bonus-label');if(bl)bl.textContent=`＋${bonusRate}% 上乗せ`;
}
async function saveCompanySettings(e){
  settings.company=document.getElementById('setting-company').value.trim();
  settings.manager=document.getElementById('setting-manager').value.trim();
  settings.address=document.getElementById('setting-address').value.trim();
  settings.bankName=document.getElementById('setting-bank-name')?.value.trim()||'';
  settings.bankBranch=document.getElementById('setting-bank-branch')?.value.trim()||'';
  settings.bankType=document.getElementById('setting-bank-type')?.value||'普通';
  settings.bankNumber=document.getElementById('setting-bank-number')?.value.trim()||'';
  settings.bankHolder=document.getElementById('setting-bank-holder')?.value.trim()||'';
  const btn=e.currentTarget;btn.textContent='⏳ 保存中...';btn.disabled=true;
  await pushData();btn.textContent='✅ 保存しました';
  setTimeout(()=>{btn.textContent='設定を保存';btn.disabled=false;},1500);
}
async function saveBonusRateSetting(e){
  const v=parseInt(document.getElementById('setting-bonus-rate').value)||10;
  settings.bonusRate=Math.max(1,Math.min(100,v));bonusRate=settings.bonusRate;
  const bi=document.getElementById('bonus-rate-input');if(bi)bi.value=bonusRate;
  const bl=document.getElementById('bonus-label');if(bl)bl.textContent=`＋${bonusRate}% 上乗せ`;
  calculate();const btn=e.currentTarget;btn.textContent='⏳...';btn.disabled=true;
  await pushData();btn.textContent='✅ 保存しました';setTimeout(()=>{btn.textContent='保存';btn.disabled=false;},1500);
}
function renderSettingsWorkers(){
  const el=document.getElementById('worker-settings-list');if(!el)return;
  if(!workers.length){el.innerHTML='<div style="color:var(--muted);font-size:.82rem;grid-column:1/-1;">まだ登録されていません</div>';return;}
  el.innerHTML=workers.map((w,i)=>`
    <div class="worker-card-sm">
      <button class="del-btn" onclick="removeWorker(${i})">✕</button>
      ${w.avatar?`<img src="${w.avatar}" class="avatar avatar-lg">`:`<div class="avatar-placeholder avatar-lg">${(w.name||'?').charAt(0).toUpperCase()}</div>`}
      <div class="wname">${w.name}</div>
      ${w.address?`<div class="waddr">${w.address}</div>`:''}
      ${w.bank&&w.bank.name?`<div class="waddr" style="color:var(--mango);font-size:.62rem;">🏦 ${w.bank.name}</div>`:'<div class="waddr" style="color:#ccc;font-size:.6rem;">口座未登録</div>'}
      <button class="btn btn-secondary btn-sm" style="margin-top:5px;font-size:.63rem;width:100%;" onclick="openWorkerModal(${i})">✏️ 編集</button>
    </div>`).join('');
}
async function removeWorker(i){if(!confirm('削除しますか？'))return;workers.splice(i,1);buildWorkerPicker();renderSettingsWorkers();await pushData();}
function renderPriceSettings(){
  const el=document.getElementById('price-settings-list');if(!el)return;
  el.innerHTML=processes.map((p,i)=>`
    <div class="price-row"><span>${p.name}</span>
      <div style="display:flex;align-items:center;gap:.28rem;"><span style="font-size:.73rem;color:var(--muted);">¥</span><input type="number" id="price-${p.id}" value="${p.price}" min="1" style="width:78px;text-align:right;"></div>
      <button class="icon-btn" onclick="removeProcess(${i})" style="color:var(--red);">✕</button>
    </div>`).join('');
}
async function addProcess(){
  const name=document.getElementById('new-proc-name').value.trim();
  const price=parseInt(document.getElementById('new-proc-price').value);
  if(!name){alert('名前を入力してください');return;}if(!price||price<1){alert('単価を入力してください');return;}
  processes.push({id:'c'+Date.now(),name,price});
  document.getElementById('new-proc-name').value='';document.getElementById('new-proc-price').value='';
  buildProcList();calculate();renderPriceSettings();await pushData();
}
async function removeProcess(i){if(!confirm(`「${processes[i].name}」を削除しますか？`))return;processes.splice(i,1);buildProcList();calculate();renderPriceSettings();await pushData();}
async function savePrices(e){
  processes.forEach(p=>{const el=document.getElementById('price-'+p.id);if(el)p.price=parseInt(el.value)||p.price;});
  buildProcList();calculate();const btn=e.currentTarget;btn.textContent='⏳ 保存中...';btn.disabled=true;
  await pushData();btn.textContent='✅ 保存しました';setTimeout(()=>{btn.textContent='単価を保存';btn.disabled=false;},1500);
}

// ── WORKER MODAL ──
function openWorkerModal(i){
  modalWorkerIndex=i;modalAvatarData=null;
  const w=i===-1?{}:workers[i];const b=w.bank||{};
  document.getElementById('modal-title').textContent=i===-1?'外注さんを追加':`${w.name} を編集`;
  document.getElementById('modal-worker-name').value=w.name||'';
  document.getElementById('modal-worker-addr').value=w.address||'';
  document.getElementById('modal-bank-name').value=b.name||'';
  document.getElementById('modal-bank-branch').value=b.branch||'';
  document.getElementById('modal-bank-type').value=b.type||'普通';
  document.getElementById('modal-bank-number').value=b.number||'';
  document.getElementById('modal-bank-holder').value=b.holder||'';
  const ring=document.getElementById('modal-avatar-ring');
  if(w.avatar){ring.innerHTML=`<img src="${w.avatar}" style="width:50px;height:50px;border-radius:50%;object-fit:cover;">`;ring.classList.add('has-img');}
  else{ring.innerHTML='📷';ring.classList.remove('has-img');}
  document.getElementById('worker-modal').classList.remove('hidden');
}
function closeWorkerModal(){document.getElementById('worker-modal').classList.add('hidden');modalWorkerIndex=-1;modalAvatarData=null;}
async function previewModalAvatar(e){
  const file=e.target.files[0];if(!file)return;
  modalAvatarData=await compressImage(file);
  const ring=document.getElementById('modal-avatar-ring');
  ring.innerHTML=`<img src="${modalAvatarData}" style="width:50px;height:50px;border-radius:50%;object-fit:cover;">`;ring.classList.add('has-img');
}
async function saveWorkerModal(){
  const name=document.getElementById('modal-worker-name').value.trim();
  const addr=document.getElementById('modal-worker-addr').value.trim();
  if(!name){alert('名前を入力してください');return;}
  const bank={name:document.getElementById('modal-bank-name').value.trim(),branch:document.getElementById('modal-bank-branch').value.trim(),
    type:document.getElementById('modal-bank-type').value,number:document.getElementById('modal-bank-number').value.trim(),
    holder:document.getElementById('modal-bank-holder').value.trim()};
  if(modalWorkerIndex===-1){
    if(workers.find(w=>w.name===name)){alert('すでに登録されています');return;}
    workers.push({id:'w'+Date.now(),name,address:addr,avatar:modalAvatarData||null,bank});
  }else{
    const w=workers[modalWorkerIndex];w.name=name;w.address=addr;w.bank=bank;if(modalAvatarData)w.avatar=modalAvatarData;
  }
  buildWorkerPicker();renderSettingsWorkers();await pushData();closeWorkerModal();
}

// ── COMPRESS ──
function compressImage(file,maxKB=60){
  return new Promise(resolve=>{
    const reader=new FileReader();
    reader.onload=ev=>{
      const img=new Image();
      img.onload=()=>{
        const canvas=document.createElement('canvas');
        let w=img.width,h=img.height;const max=200;
        if(w>max||h>max){if(w>h){h=Math.round(h*max/w);w=max;}else{w=Math.round(w*max/h);h=max;}}
        canvas.width=w;canvas.height=h;canvas.getContext('2d').drawImage(img,0,0,w,h);
        let q=0.8,result=canvas.toDataURL('image/jpeg',q);
        while(result.length>maxKB*1024*1.37&&q>0.2){q-=0.1;result=canvas.toDataURL('image/jpeg',q);}
        resolve(result);
      };img.src=ev.target.result;
    };reader.readAsDataURL(file);
  });
}

// ── SHIFT (外注) ──
function initShiftPage(){
  if(shiftCalMonth>12){shiftCalMonth=1;shiftCalYear++;}
  shiftSelectedDays=new Set();
  const sel=document.getElementById('shift-worker-select');
  sel.innerHTML='<option value="">-- 名前を選ぶ --</option>'+workers.map(w=>`<option value="${w.name}">${w.name}</option>`).join('');
  renderShiftCal();
}
function renderShiftCal(){
  document.getElementById('shift-cal-title').textContent=`${shiftCalYear}年${shiftCalMonth}月`;
  const today=new Date();today.setHours(0,0,0,0);
  const lastDay=new Date(shiftCalYear,shiftCalMonth,0).getDate();
  const startDow=new Date(shiftCalYear,shiftCalMonth-1,1).getDay();
  let cells='';
  for(let i=0;i<startDow;i++)cells+='<div class="shift-day empty"></div>';
  for(let d=1;d<=lastDay;d++){
    const date=new Date(shiftCalYear,shiftCalMonth-1,d);
    const key=`${shiftCalYear}-${String(shiftCalMonth).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dow=date.getDay();
    cells+=`<div class="shift-day ${shiftSelectedDays.has(key)?'selected':''} ${date<today?'past':''} ${dow===0?'sun':dow===6?'sat':''}" onclick="toggleShiftDay('${key}',this)">${d}</div>`;
  }
  document.getElementById('shift-cal').innerHTML=cells;updateShiftSelected();
}
function toggleShiftDay(key,el){
  if(shiftSelectedDays.has(key)){shiftSelectedDays.delete(key);el.classList.remove('selected');}
  else{shiftSelectedDays.add(key);el.classList.add('selected');}
  updateShiftSelected();
}
function updateShiftSelected(){
  const sorted=[...shiftSelectedDays].sort();
  document.getElementById('shift-selected-count').textContent=sorted.length+'日';
  document.getElementById('shift-selected-list').textContent=sorted.map(d=>parseInt(d.split('-')[2])+'日').join('・');
}
function shiftCalPrev(){shiftCalMonth--;if(shiftCalMonth<1){shiftCalMonth=12;shiftCalYear--;}renderShiftCal();}
function shiftCalNext(){shiftCalMonth++;if(shiftCalMonth>12){shiftCalMonth=1;shiftCalYear++;}renderShiftCal();}
async function submitShift(){
  const name=document.getElementById('shift-worker-select').value;
  if(!name){alert('名前を選んでください');return;}
  if(shiftSelectedDays.size===0){alert('希望日を選んでください');return;}
  shifts.unshift({id:Date.now(),workerName:name,dates:[...shiftSelectedDays].sort(),submittedAt:new Date().toLocaleString('ja-JP'),status:'pending'});
  if(shifts.length>1000)shifts=shifts.slice(0,1000);
  document.getElementById('shift-submit-result').innerHTML='<div style="background:var(--green-light);border:1.5px solid #a5d6a7;border-radius:9px;padding:1rem;color:var(--green);font-weight:700;">✅ 提出しました！ありがとうございます。</div>';
  shiftSelectedDays=new Set();renderShiftCal();await pushData();
  setTimeout(()=>{document.getElementById('shift-submit-result').innerHTML='';},4000);
}

// ── SHIFT ADMIN ──
function initShiftAdmin(){
  adminCalYear=new Date().getFullYear();adminCalMonth=new Date().getMonth()+1;
  const sel=document.getElementById('shift-filter-worker');
  sel.innerHTML='<option value="">全員</option>'+[...new Set(shifts.map(s=>s.workerName))].map(n=>`<option value="${n}">${n}</option>`).join('');
  renderAdminCal();renderShiftAdmin();
}
function renderAdminCal(){
  document.getElementById('admin-cal-title').textContent=`${adminCalYear}年${adminCalMonth}月`;
  const today=new Date();today.setHours(0,0,0,0);
  const lastDay=new Date(adminCalYear,adminCalMonth,0).getDate();
  const startDow=new Date(adminCalYear,adminCalMonth-1,1).getDay();
  const dayMap={};
  shifts.forEach(s=>s.dates.forEach(d=>{
    const[y,m]=d.split('-');
    if(parseInt(y)===adminCalYear&&parseInt(m)===adminCalMonth){
      if(!dayMap[d])dayMap[d]=[];dayMap[d].push({name:s.workerName,status:s.status});
    }
  }));
  let cells='';
  for(let i=0;i<startDow;i++)cells+='<div></div>';
  for(let d=1;d<=lastDay;d++){
    const key=`${adminCalYear}-${String(adminCalMonth).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isToday=new Date(adminCalYear,adminCalMonth-1,d).getTime()===today.getTime();
    const entries=(dayMap[key]||[]).map(e=>`<div class="shift-chip ${e.status}">${e.name.charAt(0)}</div>`).join('');
    cells+=`<div class="shift-admin-day${isToday?' today':''}"><div class="day-num">${d}</div>${entries}</div>`;
  }
  document.getElementById('admin-cal').innerHTML=cells;
}
function adminCalPrev(){adminCalMonth--;if(adminCalMonth<1){adminCalMonth=12;adminCalYear--;}renderAdminCal();}
function adminCalNext(){adminCalMonth++;if(adminCalMonth>12){adminCalMonth=1;adminCalYear++;}renderAdminCal();}
function renderShiftAdmin(){
  const wf=document.getElementById('shift-filter-worker')?.value||'';
  const sf=document.getElementById('shift-filter-status')?.value||'';
  let list=shifts;if(wf)list=list.filter(s=>s.workerName===wf);if(sf)list=list.filter(s=>s.status===sf);
  const el=document.getElementById('shift-admin-list');
  if(!list.length){el.innerHTML='<div style="color:var(--muted);font-size:.82rem;">希望はまだありません</div>';return;}
  el.innerHTML=list.map(s=>{
    const badge=s.status==='approved'?'<span class="shift-status-badge approved">承認済み</span>':
      s.status==='rejected'?'<span class="shift-status-badge rejected">却下</span>':
      '<span class="shift-status-badge pending">未確認</span>';
    const dates=s.dates.map(d=>{const[,m,day]=d.split('-');return`${parseInt(m)}/${parseInt(day)}`;}).join('・');
    const aBtn=s.status!=='approved'?`<button class="btn btn-green btn-sm" onclick="approveShift(${s.id})">✓ 承認</button>`:'';
    const rBtn=s.status!=='rejected'?`<button class="btn btn-sm" style="background:var(--red-light);color:var(--red);border:1px solid #ef9a9a;" onclick="rejectShift(${s.id})">✕ 却下</button>`:'';
    return`<div class="shift-list-item ${s.status}">
      <div style="flex:1;min-width:0;"><div style="font-weight:700;font-size:.87rem;">${s.workerName} ${badge}</div>
      <div style="font-size:.7rem;color:var(--muted);margin-top:.18rem;">${dates}</div>
      <div style="font-size:.62rem;color:var(--muted);margin-top:.1rem;">提出：${s.submittedAt}</div></div>
      <div style="display:flex;gap:.3rem;">${aBtn}${rBtn}<button class="icon-btn" onclick="deleteShift(${s.id})" style="color:var(--red);">🗑</button></div>
    </div>`;
  }).join('');
}
async function approveShift(id){const s=shifts.find(x=>x.id===id);if(!s)return;s.status='approved';renderShiftAdmin();renderAdminCal();await pushData();}
async function rejectShift(id){const s=shifts.find(x=>x.id===id);if(!s)return;s.status='rejected';renderShiftAdmin();renderAdminCal();await pushData();}
async function deleteShift(id){if(!confirm('削除しますか？'))return;shifts=shifts.filter(x=>x.id!==id);renderShiftAdmin();renderAdminCal();await pushData();}

// ── PRINT ──
function buildPrintDoc(recs,title){
  if(!recs.length)return'<p>対象の記録がありません</p>';
  const comp=settings.company||'Global Mango System',mgr=settings.manager||'',addr=settings.address||'';
  const wn=recs[0].name,wa=recs[0].address||'';
  const wObj=workers.find(w=>w.name===wn);const wb=wObj?.bank||{};const sb=settings;
  const tp=recs.reduce((a,r)=>a+r.total,0),tax=Math.round(tp*.1),wt=tp+tax;
  const month=recs[0].date.slice(0,7);const docNo=`${month.replace('-','')}-${wn.replace(/\s/g,'')}`;
  let twMs=0,tbMs=0;
  recs.forEach(r=>{
    if(r.timerWorkMs)twMs+=r.timerWorkMs;
    if(r.timerLog&&r.timerLog.length){let lp=null;r.timerLog.forEach(l=>{if(l.type==='休憩')lp=l.time;if((l.type==='再開'||l.type==='終了')&&lp){tbMs+=new Date(l.time)-new Date(lp);lp=null;}});}
  });
  const hasTimer=twMs>0;
  const twh=Math.floor(twMs/3600000),twm=Math.floor((twMs%3600000)/60000);
  const tbh=Math.floor(tbMs/3600000),tbm=Math.floor((tbMs%3600000)/60000);
  let rows='';
  recs.forEach(r=>{
    r.items.forEach((it,i)=>{rows+=`<tr><td class="dc">${i===0?r.date:''}</td><td>${it.name}</td><td class="num">¥${it.price.toLocaleString()}</td><td class="num">${it.isHourly?it.qty+'h':it.qty+'個'}</td><td class="num">¥${it.sub.toLocaleString()}</td><td class="num">¥${Math.round(it.sub*.1).toLocaleString()}</td></tr>`;});
    if(r.bonusOn)rows+=`<tr><td></td><td>＋${r.bonusRate||10}%上乗せ</td><td></td><td></td><td class="num">¥${r.bonusAmt.toLocaleString()}</td><td class="num">¥${Math.round(r.bonusAmt*.1).toLocaleString()}</td></tr>`;
    rows+=`<tr class="sub"><td class="dc">${r.date}</td><td colspan="3">日計</td><td class="num">¥${r.total.toLocaleString()}</td><td class="num">¥${Math.round(r.total*.1).toLocaleString()}</td></tr>`;
  });
  const remarks=recs.filter(r=>r.remarks).map(r=>`[${r.date}] ${r.remarks}`).join('\n');
  return`<div class="dh"><div><div class="dt">支 払 明 細 書</div><div class="dn">文書番号：${docNo}</div></div><div class="di"><div class="dc2">${comp}</div>${mgr?`<div class="ds">担当：${mgr}</div>`:''}${addr?`<div class="ds">${addr}</div>`:''}</div></div>
  <div class="dm"><div class="mb"><div class="ml">支払先</div><div class="mv">${wn} 様</div>${wa?`<div style="font-size:8.5pt;color:#555;margin-top:1mm;">${wa}</div>`:''}</div><div class="mb"><div class="ml">対象期間</div><div class="mv">${title}</div><div style="font-size:7.5pt;color:#555;margin-top:1mm;">作業件数：${recs.length}件</div></div></div>
  <div class="dp">■ 加工作業明細</div>
  <table class="dtb"><thead><tr><th style="width:22mm;">作業日</th><th>加工の種類</th><th style="width:17mm;">単価</th><th style="width:17mm;">数量</th><th style="width:21mm;">金額（税抜）</th><th style="width:17mm;">消費税</th></tr></thead><tbody>${rows}</tbody></table>
  <div class="cf">
    <div class="tot"><div class="tr2"><span>税抜合計</span><span>¥${tp.toLocaleString()}</span></div><div class="tr2"><span>消費税（10%）</span><span>¥${tax.toLocaleString()}</span></div><div class="tr2 g"><span>税込合計</span><span>¥${wt.toLocaleString()}</span></div></div>
    ${hasTimer?`<div class="tmb"><div class="tml">⏱ 作業時間記録</div><div class="tmg"><div><div class="tms">作業合計</div><div class="tmv">${twh}時間${String(twm).padStart(2,'0')}分</div></div><div><div class="tms">休憩合計</div><div class="tmv">${tbh}時間${String(tbm).padStart(2,'0')}分</div></div></div></div>`:''}
    <div class="rem"><div class="reml">備考</div><div class="remt">${remarks||'　'}</div></div>
  </div>
  ${(wb.name||sb.bankName)?`<div class="bks"><div class="bkg">${wb.name?`<div class="bkb"><div class="bkl">振込先（外注さん口座）</div><div class="bkn">${wb.name} ${wb.branch||''}</div><div class="bkd">${wb.type||'普通'} ${wb.number||''}<br>名義：${wb.holder||wn}</div></div>`:'<div></div>'}${sb.bankName?`<div class="bkb"><div class="bkl">振込元（自社口座）</div><div class="bkn">${sb.bankName} ${sb.bankBranch||''}</div><div class="bkd">${sb.bankType||'普通'} ${sb.bankNumber||''}<br>名義：${sb.bankHolder||comp}</div></div>`:''}</div></div>`:''}
  <div class="sa"><div class="sb"><div class="sc"></div><div class="sl">確認印</div></div><div class="sb"><div class="sc"></div><div class="sl">承認印</div></div></div>
  <div class="ft">本明細書は${new Date().toLocaleDateString('ja-JP')}に発行されました。 | ${comp}</div>`;
}
function openPrintPreview(){
  const month=document.getElementById('filter-month').value,wf=document.getElementById('filter-worker').value;
  if(!month){alert('月を選択してください');return;}
  let f=records.filter(r=>r.date.startsWith(month));if(wf)f=f.filter(r=>r.name===wf);
  if(!f.length){alert('対象の記録がありません');return;}
  const[y,m]=month.split('-');
  document.getElementById('print-doc').innerHTML=buildPrintDoc(f,`${y}年${parseInt(m)}月分`);
  document.getElementById('print-overlay').classList.add('open');
}
function printSingle(id){const r=records.find(h=>h.id===id);if(!r)return;document.getElementById('print-doc').innerHTML=buildPrintDoc([r],r.date+'分');document.getElementById('print-overlay').classList.add('open');}
function closePrint(){document.getElementById('print-overlay').classList.remove('open');}
function doPrint(){
  const html=document.getElementById('print-doc').innerHTML;
  const win=window.open('','_blank','width=900,height=700');
  win.document.write(`<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Noto+Serif+JP:wght@400;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"><style>
body{font-family:'Noto Serif JP',serif;margin:0;padding:18mm 16mm;color:#000;}
.dh{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:7mm;padding-bottom:4mm;border-bottom:2.5px solid #ff8c00;}
.dt{font-size:21pt;font-weight:700;letter-spacing:4px;color:#e65c00;}.dn{font-size:7.5pt;color:#888;margin-top:2mm;font-family:'DM Mono',monospace;}
.di{text-align:right;}.dc2{font-size:12pt;font-weight:700;}.ds{font-size:7.5pt;color:#777;}
.dm{display:grid;grid-template-columns:1fr 1fr;gap:4mm;margin-bottom:6mm;}
.mb{border:1px solid #f0d9b5;border-radius:3px;padding:2.5mm 3.5mm;background:#fff8f0;}
.ml{font-size:7pt;color:#aaa;letter-spacing:1px;text-transform:uppercase;margin-bottom:1mm;}.mv{font-size:10.5pt;font-weight:700;}
.dp{background:#ff8c00;color:#fff;padding:2mm 4mm;font-size:8.5pt;font-weight:700;letter-spacing:1px;margin-bottom:4.5mm;border-radius:2px;}
.dtb{width:100%;border-collapse:collapse;margin-bottom:4.5mm;}
.dtb th{background:#fff3e0;border:1px solid #f0d9b5;padding:1.8mm 2.5mm;font-size:7.5pt;text-align:center;font-weight:700;}
.dtb td{border:1px solid #f0d9b5;padding:2mm 2.5mm;font-size:8.5pt;vertical-align:middle;}
.dtb td.num{text-align:right;font-family:'DM Mono',monospace;}.dtb tr:nth-child(even) td{background:#fffde7;}
.dtb .dc{font-family:'DM Mono',monospace;font-size:7.5pt;color:#888;}.dtb .sub td{background:#fff3e0;font-weight:700;}
.cf::after{content:'';display:table;clear:both;}
.tot{float:right;width:65mm;border:1px solid #f0d9b5;border-radius:3px;overflow:hidden;margin-bottom:4.5mm;}
.tr2{display:flex;justify-content:space-between;padding:1.8mm 3.5mm;font-size:8.5pt;border-bottom:1px solid #f0d9b5;}
.tr2.g{background:#ff8c00;color:#fff;font-weight:700;font-size:10.5pt;border-bottom:none;}
.tmb{border:1px solid #ffe0b2;border-radius:3px;padding:2.5mm 3.5mm;margin-bottom:4mm;background:#fff8f0;}
.tml{font-size:7pt;color:#e65c00;font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:1.5mm;}
.tmg{display:grid;grid-template-columns:1fr 1fr;gap:2mm;}.tms{font-size:7pt;color:#aaa;}
.tmv{font-size:10pt;font-weight:700;font-family:'DM Mono',monospace;color:#e65c00;}
.rem{clear:both;border:1px solid #f0d9b5;border-radius:3px;padding:2.5mm 3.5mm;margin-bottom:4.5mm;min-height:18mm;}
.reml{font-size:7pt;color:#aaa;letter-spacing:1px;text-transform:uppercase;margin-bottom:1.5mm;}.remt{font-size:8.5pt;white-space:pre-wrap;}
.bks{margin-bottom:4.5mm;}.bkg{display:grid;grid-template-columns:1fr 1fr;gap:3mm;}
.bkb{border:1px solid #f0d9b5;border-radius:3px;padding:2.5mm 3.5mm;}
.bkl{font-size:7pt;color:#aaa;letter-spacing:1px;text-transform:uppercase;margin-bottom:1.5mm;font-weight:700;}
.bkn{font-size:10pt;font-weight:700;margin-bottom:1mm;}.bkd{font-size:8pt;color:#555;line-height:1.7;font-family:'DM Mono',monospace;}
.sa{display:flex;justify-content:flex-end;gap:4.5mm;margin-top:4mm;}
.sb{text-align:center;width:20mm;}.sc{width:16mm;height:16mm;border:1px solid #ccc;border-radius:50%;margin:0 auto 1mm;}.sl{font-size:6.5pt;color:#aaa;}
.ft{text-align:center;font-size:6.5pt;color:#ccc;border-top:1px solid #f0d9b5;padding-top:2.5mm;margin-top:5mm;}
@media print{body{margin:0;padding:15mm 12mm;}@page{margin:0;size:A4;}}
</style></head><body>${html}</body></html>`);
  win.document.close();win.onload=()=>{win.focus();win.print();};
}
function exportCSV(){
  const month=document.getElementById('filter-month').value,wf=document.getElementById('filter-worker').value;
  let f=records;if(month)f=f.filter(r=>r.date.startsWith(month));if(wf)f=f.filter(r=>r.name===wf);
  if(!f.length){alert('対象の記録がありません');return;}
  const rows=[['作業日','名前','住所','ステータス','加工の種類','単価','数量','小計','上乗せ','合計','備考']];
  f.forEach(r=>{r.items.forEach((it,i)=>{rows.push([r.date,r.name,r.address||'',r.status||'pending',it.name,it.price,it.isHourly?it.qty+'h':it.qty,it.sub,i===0?(r.bonusOn?'有':'無'):'',i===0?r.total:'',i===0?(r.remarks||''):'']);});});
  const bom='\uFEFF',csv=bom+rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));a.download=`GMS_${month||'all'}.csv`;a.click();
}


// ── MOBILE UI ──
function toggleDrawer(){
  const d=document.getElementById('mobile-drawer'),h=document.getElementById('hamburger');
  d.classList.toggle('open');h.classList.toggle('open');
}
function closeDrawer(){
  document.getElementById('mobile-drawer').classList.remove('open');
  document.getElementById('hamburger').classList.remove('open');
}
function drawerNav(id,btn){
  document.querySelectorAll('.drawer-panel .nav-btn').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  showPage(id,null);setBottomActive(id);closeDrawer();
}
function drawerRequestPage(id){
  requestPage(id,null);
}
function setBottomActive(id){
  document.querySelectorAll('.bnav-btn').forEach(b=>b.classList.remove('active'));
  const el=document.getElementById('bnav-'+id);if(el)el.classList.add('active');
  const adminPages=['history','shift-admin','settings'];
  if(adminPages.includes(id))document.getElementById('bnav-admin').classList.add('active');
}
function openAdminSheet(){document.getElementById('asheet').classList.add('open');}
function closeAdminSheet(){document.getElementById('asheet').classList.remove('open');}
function updateSyncMobile(state,label){
  const dot=document.getElementById('sync-dot-m');if(dot)dot.className='sync-dot'+(state==='offline'?' offline':'');
  const lbl=document.getElementById('sync-label-m');if(lbl)lbl.textContent=label;
}

// ── INIT ──
async function initApp(){
  document.getElementById('work-date').value=new Date().toISOString().slice(0,10);
  const now=new Date();
  shiftCalMonth=now.getMonth()===11?1:now.getMonth()+2;
  shiftCalYear=now.getMonth()===11?now.getFullYear()+1:now.getFullYear();
  buildProcList();buildWorkerPicker();calculate();
}
(async()=>{await pullData();await initApp();})();
</script>
</body>
</html>
