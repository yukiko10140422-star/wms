<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WMS â€” æ¢±åŒ…å¤–æ³¨ çµ¦æ–™è¨ˆç®—</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Noto+Serif+JP:wght@400;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#f4f7fb; --white:#fff; --ink:#1a1f2e; --muted:#6b7385;
  --border:#dde3ee; --border-dark:#b0b9ce;
  --accent:#1a56db; --accent-light:#eef3ff;
  --red:#b03030;
  --shadow:0 1px 3px rgba(26,50,100,.07),0 4px 12px rgba(26,50,100,.05);
  --shadow-lg:0 4px 24px rgba(26,50,100,.12);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--ink);font-family:'Noto Sans JP',sans-serif;min-height:100vh;}


/* â”€â”€ SYNC STATUS BAR â”€â”€ */
#sync-bar{position:fixed;top:0;left:0;right:0;height:3px;z-index:300;background:transparent;transition:background .3s;}
#sync-bar.loading{background:linear-gradient(90deg,var(--accent) 40%,transparent 100%);animation:pulse 1s infinite;}
#sync-bar.ok{background:#0e9f6e;animation:fadeout 1.2s forwards 0.8s;}
#sync-bar.err{background:#e53e3e;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
@keyframes fadeout{to{opacity:0}}

.sync-toast{position:fixed;bottom:1.2rem;right:1.2rem;background:#1a1f2e;color:#fff;border-radius:8px;padding:.55rem 1rem;font-size:.8rem;display:flex;align-items:center;gap:.5rem;box-shadow:var(--shadow-lg);z-index:300;transform:translateY(20px);opacity:0;transition:all .25s;}
.sync-toast.show{transform:translateY(0);opacity:1;}

.app-shell{display:flex;min-height:100vh;}

.sidebar{width:260px;background:#1a1f2e;color:#fff;padding:1.6rem 1.2rem;display:flex;flex-direction:column;gap:1.8rem;flex-shrink:0;position:sticky;top:0;height:100vh;overflow-y:auto;}
.brand{border-bottom:1px solid rgba(255,255,255,.1);padding-bottom:1.4rem;}
.brand-name{font-size:1.25rem;font-weight:900;letter-spacing:1px;}
.brand-sub{font-size:0.68rem;color:rgba(255,255,255,.38);margin-top:3px;letter-spacing:1px;}
.sync-info{margin-top:.5rem;font-size:.65rem;color:rgba(255,255,255,.3);display:flex;align-items:center;gap:.35rem;}
.sync-dot{width:7px;height:7px;border-radius:50%;background:#4ade80;flex-shrink:0;}
.sync-dot.offline{background:#f87171;}
.nav-label{font-size:.62rem;font-weight:700;letter-spacing:2px;color:rgba(255,255,255,.3);text-transform:uppercase;margin-bottom:.4rem;}
.nav-btn{display:flex;align-items:center;gap:.55rem;width:100%;background:none;border:none;color:rgba(255,255,255,.55);padding:.55rem .75rem;border-radius:7px;cursor:pointer;font-family:'Noto Sans JP',sans-serif;font-size:.86rem;font-weight:500;text-align:left;transition:all .15s;margin-bottom:2px;}
.nav-btn:hover{background:rgba(255,255,255,.08);color:#fff;}
.nav-btn.active{background:var(--accent);color:#fff;}
.nav-btn .icon{font-size:.95rem;width:1.1rem;text-align:center;}

.main{flex:1;padding:2rem;max-width:920px;overflow-x:hidden;}
.page{display:none;}
.page.active{display:block;animation:fadein .22s ease;}
@keyframes fadein{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}

.page-header{margin-bottom:1.6rem;}
.page-header h2{font-size:1.45rem;font-weight:900;letter-spacing:-.5px;}
.page-header p{color:var(--muted);font-size:.83rem;margin-top:.3rem;}

.card{background:var(--white);border:1px solid var(--border);border-radius:10px;padding:1.3rem 1.5rem;margin-bottom:.9rem;box-shadow:var(--shadow);}
.card-head{font-size:.65rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);padding-bottom:.75rem;margin-bottom:.9rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.4rem;}

.field-row{display:grid;gap:.7rem;margin-bottom:.7rem;}
.field-row.col2{grid-template-columns:1fr 1fr;}
.field-row.col3{grid-template-columns:1fr 1fr 1fr;}
.field{display:flex;flex-direction:column;gap:.28rem;}
.field label{font-size:.73rem;font-weight:700;color:var(--muted);}
input[type="text"],input[type="date"],input[type="number"],textarea,select{background:var(--bg);border:1.5px solid var(--border);border-radius:6px;padding:.52rem .72rem;font-family:'Noto Sans JP',sans-serif;font-size:.88rem;color:var(--ink);outline:none;transition:border-color .15s,box-shadow .15s;width:100%;}
input:focus,textarea:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(26,86,219,.1);background:#fff;}
textarea{resize:vertical;min-height:66px;}

.proc-list{display:flex;flex-direction:column;gap:.35rem;}
.proc-row{display:grid;grid-template-columns:1fr 90px 90px 90px;align-items:center;gap:.5rem;background:var(--bg);border:1.5px solid var(--border);border-radius:7px;padding:.55rem .75rem;transition:border-color .15s;}
.proc-row.has-value{border-color:var(--accent);background:var(--accent-light);}
.proc-name{font-weight:700;font-size:.86rem;}
.proc-row input[type="number"]{text-align:center;padding:.32rem .35rem;font-family:'DM Mono',monospace;font-size:.9rem;}
.proc-subtotal{font-family:'DM Mono',monospace;font-size:.88rem;font-weight:500;text-align:right;color:var(--muted);}
.proc-subtotal.active{color:var(--accent);font-weight:700;}
.proc-header{display:grid;grid-template-columns:1fr 90px 90px 90px;gap:.5rem;padding:0 .75rem .35rem;font-size:.65rem;font-weight:700;color:var(--muted);letter-spacing:1px;text-transform:uppercase;}
.proc-header span:not(:first-child){text-align:center;}
.proc-header span:last-child{text-align:right;}

.bonus-toggle{display:flex;align-items:center;gap:.75rem;background:#f0f4ff;border:1.5px solid #99aadd;border-radius:7px;padding:.75rem 1rem;cursor:pointer;user-select:none;transition:background .15s;}
.bonus-toggle:hover{background:#e4ecff;}
.bonus-toggle.on{background:var(--accent-light);border-color:var(--accent);}
.tog-switch{width:40px;height:22px;background:var(--border-dark);border-radius:99px;position:relative;flex-shrink:0;transition:background .2s;}
.tog-switch::after{content:'';position:absolute;top:3px;left:3px;width:16px;height:16px;background:#fff;border-radius:50%;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.2);}
.bonus-toggle.on .tog-switch{background:var(--accent);}
.bonus-toggle.on .tog-switch::after{transform:translateX(18px);}
.tog-text .tog-main{font-weight:700;font-size:.88rem;}
.tog-text .tog-sub{font-size:.73rem;color:var(--muted);}

.total-card{background:linear-gradient(135deg,#1a1f2e 0%,#243060 100%);color:#fff;border:none;}
.total-card .card-head{color:rgba(255,255,255,.38);border-color:rgba(255,255,255,.1);}
.total-rows{display:flex;flex-direction:column;gap:.45rem;margin-bottom:.9rem;}
.total-row{display:flex;justify-content:space-between;font-size:.86rem;color:rgba(255,255,255,.55);font-family:'DM Mono',monospace;}
.total-row.bold{color:#fff;font-weight:500;}
.total-sep{border:none;border-top:1px solid rgba(255,255,255,.15);margin:.25rem 0;}
.grand-total{display:flex;justify-content:space-between;align-items:baseline;}
.gt-label{font-size:.83rem;color:rgba(255,255,255,.55);font-weight:700;}
.gt-amount{font-family:'DM Mono',monospace;font-size:2rem;font-weight:500;color:#63a9ff;letter-spacing:-1px;}

.btn-group{display:flex;gap:.55rem;flex-wrap:wrap;margin-top:.9rem;}
.btn{border:none;border-radius:7px;padding:.65rem 1.2rem;font-family:'Noto Sans JP',sans-serif;font-weight:700;font-size:.83rem;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:.38rem;}
.btn:active{transform:scale(.97);}
.btn:disabled{opacity:.5;cursor:not-allowed;}
.btn-primary{background:var(--accent);color:#fff;box-shadow:0 2px 8px rgba(26,86,219,.28);}
.btn-primary:hover:not(:disabled){background:#1546b8;}
.btn-secondary{background:var(--white);color:var(--ink);border:1.5px solid var(--border);}
.btn-secondary:hover:not(:disabled){background:var(--bg);}
.btn-danger{background:#fff0f0;color:var(--red);border:1.5px solid #f0d0d0;}
.btn-danger:hover:not(:disabled){background:#ffe4e4;}
.btn-green{background:#0e9f6e;color:#fff;}
.btn-green:hover:not(:disabled){background:#0b8860;}
.btn-sm{padding:.3rem .65rem;font-size:.78rem;}

.avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid var(--border);flex-shrink:0;background:var(--bg);}
.avatar-placeholder{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#c7d8f8,#8fb4f0);border:2px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:.95rem;font-weight:900;color:var(--accent);text-transform:uppercase;user-select:none;}
.avatar-lg{width:56px;height:56px;font-size:1.35rem;}
.avatar-sm{width:28px;height:28px;font-size:.7rem;}

.avatar-upload{position:relative;cursor:pointer;}
.avatar-upload input[type="file"]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.avatar-upload-ring{width:56px;height:56px;border-radius:50%;border:2px dashed var(--border-dark);display:flex;align-items:center;justify-content:center;font-size:1.4rem;color:var(--muted);transition:border-color .15s,background .15s;background:var(--bg);}
.avatar-upload:hover .avatar-upload-ring{border-color:var(--accent);background:var(--accent-light);color:var(--accent);}
.avatar-upload-ring.has-img{border-style:solid;border-color:var(--accent);}

.worker-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:.75rem;margin-bottom:.9rem;}
.worker-card-sm{background:var(--bg);border:1.5px solid var(--border);border-radius:10px;padding:.8rem .7rem;display:flex;flex-direction:column;align-items:center;gap:.4rem;position:relative;transition:box-shadow .15s;}
.worker-card-sm:hover{box-shadow:var(--shadow-lg);}
.worker-card-sm .wname{font-weight:700;font-size:.82rem;text-align:center;}
.worker-card-sm .waddr{font-size:.7rem;color:var(--muted);text-align:center;line-height:1.4;}
.worker-card-sm .del-btn{position:absolute;top:5px;right:5px;background:none;border:none;cursor:pointer;color:var(--muted);font-size:.8rem;line-height:1;padding:2px 4px;border-radius:4px;}
.worker-card-sm .del-btn:hover{background:#fff0f0;color:var(--red);}

.worker-picker{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.35rem;}
.worker-chip{display:flex;align-items:center;gap:.4rem;border:1.5px solid var(--border);border-radius:99px;padding:.28rem .7rem .28rem .32rem;cursor:pointer;background:var(--bg);transition:all .15s;user-select:none;}
.worker-chip:hover{border-color:var(--accent);background:var(--accent-light);}
.worker-chip.selected{border-color:var(--accent);background:var(--accent-light);box-shadow:0 0 0 2px rgba(26,86,219,.18);}
.worker-chip span{font-size:.82rem;font-weight:700;}

.history-controls{display:flex;gap:.7rem;margin-bottom:1.1rem;flex-wrap:wrap;align-items:flex-end;}
.record-card{background:var(--white);border:1px solid var(--border);border-radius:10px;margin-bottom:.7rem;box-shadow:var(--shadow);overflow:hidden;transition:box-shadow .15s;}
.record-card:hover{box-shadow:var(--shadow-lg);}
.record-header{display:flex;align-items:center;justify-content:space-between;padding:.9rem 1.3rem;cursor:pointer;gap:1rem;}
.record-left{display:flex;align-items:center;gap:.75rem;flex:1;}
.record-date-badge{background:var(--accent-light);color:var(--accent);border:1px solid #bcd0ff;border-radius:5px;padding:.18rem .55rem;font-family:'DM Mono',monospace;font-size:.76rem;font-weight:500;white-space:nowrap;}
.record-name{font-weight:700;font-size:.93rem;}
.record-summary{font-size:.73rem;color:var(--muted);margin-top:1px;}
.record-amount{font-family:'DM Mono',monospace;font-size:1.08rem;font-weight:700;color:var(--accent);white-space:nowrap;}
.record-actions{display:flex;gap:.35rem;}
.icon-btn{background:none;border:1px solid var(--border);border-radius:5px;padding:.28rem .48rem;cursor:pointer;font-size:.88rem;transition:all .15s;color:var(--muted);}
.icon-btn:hover{background:var(--bg);color:var(--ink);}
.icon-btn.del:hover{background:#fff0f0;color:var(--red);border-color:#f0d0d0;}
.record-detail{display:none;border-top:1px solid var(--border);padding:.9rem 1.3rem;background:var(--bg);}
.record-detail.open{display:block;}
.mini-table{width:100%;border-collapse:collapse;font-size:.8rem;}
.mini-table th{text-align:left;padding:.28rem .45rem;color:var(--muted);font-size:.67rem;letter-spacing:1px;text-transform:uppercase;border-bottom:1px solid var(--border);}
.mini-table td{padding:.38rem .45rem;border-bottom:1px solid var(--border);}
.mini-table td:not(:first-child){text-align:right;font-family:'DM Mono',monospace;}
.mini-table tr:last-child td{border-bottom:none;}
.mini-table .subtotal-row td{font-weight:700;color:var(--accent);background:var(--accent-light);}
.empty{text-align:center;padding:3rem 1rem;color:var(--muted);}
.empty .icon{font-size:2.3rem;margin-bottom:.5rem;}

.month-summary{background:var(--white);border:1px solid var(--border);border-radius:10px;padding:.9rem 1.3rem;margin-bottom:1.1rem;display:flex;gap:1.4rem;flex-wrap:wrap;box-shadow:var(--shadow);}
.summary-stat{display:flex;flex-direction:column;gap:2px;}
.stat-label{font-size:.65rem;font-weight:700;color:var(--muted);letter-spacing:1px;text-transform:uppercase;}
.stat-value{font-family:'DM Mono',monospace;font-size:1.08rem;font-weight:700;color:var(--ink);}
.stat-value.accent{color:var(--accent);}

.worker-row,.price-row{display:flex;align-items:center;gap:.5rem;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:.55rem .75rem;}
.worker-row span,.price-row span{flex:1;font-weight:700;font-size:.86rem;}

.print-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:100;overflow-y:auto;padding:2rem;}
.print-overlay.open{display:flex;justify-content:center;align-items:flex-start;}
.print-doc{background:#fff;width:210mm;min-height:297mm;padding:18mm 16mm;font-family:'Noto Serif JP','Noto Sans JP',serif;box-shadow:0 8px 40px rgba(0,0,0,.3);color:#000;position:relative;}
.doc-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:7mm;padding-bottom:4mm;border-bottom:2px solid #000;}
.doc-title{font-size:21pt;font-weight:700;letter-spacing:4px;}
.doc-no{font-size:7.5pt;color:#555;margin-top:2mm;font-family:'DM Mono',monospace;}
.doc-issuer{text-align:right;}
.doc-issuer .company{font-size:12pt;font-weight:700;}
.doc-issuer .sub{font-size:7.5pt;color:#555;}
.doc-meta{display:grid;grid-template-columns:1fr 1fr;gap:4mm;margin-bottom:6mm;}
.meta-box{border:1px solid #ccc;border-radius:3px;padding:2.5mm 3.5mm;}
.meta-label{font-size:7pt;color:#777;letter-spacing:1px;text-transform:uppercase;margin-bottom:1mm;}
.meta-value{font-size:10.5pt;font-weight:700;}
.doc-period-bar{background:#1a1f2e;color:#fff;padding:2mm 4mm;font-size:8.5pt;font-weight:700;letter-spacing:1px;margin-bottom:4.5mm;border-radius:2px;}
.doc-table{width:100%;border-collapse:collapse;margin-bottom:4.5mm;}
.doc-table th{background:#eef3ff;border:1px solid #ccc;padding:1.8mm 2.5mm;font-size:7.5pt;text-align:center;font-weight:700;}
.doc-table td{border:1px solid #ccc;padding:2mm 2.5mm;font-size:8.5pt;vertical-align:middle;}
.doc-table td.num{text-align:right;font-family:'DM Mono',monospace;}
.doc-table tr:nth-child(even) td{background:#f7f9ff;}
.doc-table .date-col{font-family:'DM Mono',monospace;font-size:7.5pt;color:#555;}
.doc-table .subtotal-row td{background:#eef3ff;font-weight:700;}
.doc-totals{float:right;width:62mm;border:1px solid #ccc;border-radius:3px;overflow:hidden;margin-bottom:4.5mm;}
.doc-totals-row{display:flex;justify-content:space-between;padding:1.8mm 3.5mm;font-size:8.5pt;border-bottom:1px solid #eee;}
.doc-totals-row:last-child{background:#1a1f2e;color:#fff;font-weight:700;font-size:10.5pt;border-bottom:none;}
.clearfix::after{content:'';display:table;clear:both;}
.doc-remarks{clear:both;border:1px solid #ccc;border-radius:3px;padding:2.5mm 3.5mm;margin-bottom:4.5mm;min-height:18mm;}
.doc-remarks-label{font-size:7pt;color:#777;letter-spacing:1px;text-transform:uppercase;margin-bottom:1.5mm;}
.doc-remarks-text{font-size:8.5pt;white-space:pre-wrap;}
.doc-seal-area{display:flex;justify-content:flex-end;gap:4.5mm;margin-top:4mm;}
.seal-box{text-align:center;width:20mm;}
.seal-circle{width:16mm;height:16mm;border:1px solid #ccc;border-radius:50%;margin:0 auto 1mm;}
.seal-label{font-size:6.5pt;color:#777;}
.doc-footer{position:absolute;bottom:9mm;left:16mm;right:16mm;text-align:center;font-size:6.5pt;color:#aaa;border-top:1px solid #e0e0e0;padding-top:2.5mm;}
.print-actions{background:#1a1f2e;color:#fff;padding:.9rem 2rem;display:flex;gap:.7rem;justify-content:center;position:sticky;top:0;z-index:101;}

@media print{body *{visibility:hidden;}.print-doc,.print-doc *{visibility:visible;}.print-doc{position:fixed;left:0;top:0;width:100%;padding:15mm;box-shadow:none;}.print-overlay{display:none !important;}.no-print{display:none !important;}}
@media (max-width:768px){.app-shell{flex-direction:column;}.sidebar{width:100%;height:auto;position:relative;flex-direction:row;flex-wrap:wrap;padding:1rem;gap:.5rem;}.brand{border-bottom:none;padding-bottom:0;}.main{padding:1rem;}.proc-row{grid-template-columns:1fr 70px 70px;}.proc-row .proc-subtotal{display:none;}.proc-header span:last-child{display:none;}.field-row.col2,.field-row.col3{grid-template-columns:1fr;}.print-doc{width:100%;padding:5mm;}}
</style>
</head>
<body>

<!-- API KEY GATE (embedded key, no dialog needed) -->

<!-- SYNC STATUS -->
<div id="sync-bar"></div>
<div class="sync-toast" id="sync-toast"></div>

<div class="app-shell">

<aside class="sidebar no-print">
  <div class="brand">
    <div>
      <div class="brand-name">WMS</div>
      <div class="brand-sub">æ¢±åŒ…å¤–æ³¨ çµ¦æ–™è¨ˆç®—</div>
    </div>
    <div class="sync-info" style="margin-top:.6rem;">
      <div class="sync-dot" id="sync-dot"></div>
      <span id="sync-label">æ¥ç¶šä¸­...</span>
    </div>
  </div>
  <div>
    <div class="nav-label">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
    <button class="nav-btn active" onclick="showPage('input',this)"><span class="icon">âœï¸</span>çµ¦æ–™å…¥åŠ›</button>
    <button class="nav-btn" onclick="showPage('history',this)"><span class="icon">ğŸ“‹</span>å±¥æ­´ãƒ»æ˜ç´°æ›¸</button>
    <button class="nav-btn" onclick="showPage('settings',this)"><span class="icon">âš™ï¸</span>è¨­å®š</button>
  </div>
  <div style="margin-top:auto;display:flex;flex-direction:column;gap:.5rem;">
    <button class="btn btn-secondary btn-sm" onclick="forcePull()" style="background:rgba(255,255,255,.07);color:rgba(255,255,255,.6);border-color:rgba(255,255,255,.15);">ğŸ”„ ä»Šã™ãåŒæœŸ</button>
    <div style="font-size:.68rem;color:rgba(255,255,255,.28);line-height:1.7;">ãƒ‡ãƒ¼ã‚¿ã¯JSONBin.ioã«<br>ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜ã•ã‚Œã¾ã™ã€‚</div>
  </div>
</aside>

<main class="main">

<!-- INPUT -->
<div class="page active" id="page-input">
  <div class="page-header"><h2>çµ¦æ–™å…¥åŠ›</h2><p>å¤–æ³¨ã•ã‚“ã‚’é¸ã‚“ã§åŠ å·¥å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p></div>

  <div class="card">
    <div class="card-head">ğŸ‘¤ å¤–æ³¨ã•ã‚“ã‚’é¸ã¶</div>
    <div class="worker-picker" id="worker-picker">
      <span style="color:var(--muted);font-size:.82rem;">è¨­å®šãƒšãƒ¼ã‚¸ã§å¤–æ³¨ã•ã‚“ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</span>
    </div>
    <div style="margin-top:.75rem;">
      <div class="field-row col3">
        <div class="field"><label>ä½œæ¥­æ—¥</label><input type="date" id="work-date"></div>
        <div class="field"><label>åå‰ï¼ˆç›´æ¥å…¥åŠ›ã‚‚å¯ï¼‰</label><input type="text" id="worker-name" list="worker-list" placeholder="ä¾‹ï¼šå±±ç”° èŠ±å­"><datalist id="worker-list"></datalist></div>
        <div class="field"><label>ä½æ‰€</label><input type="text" id="worker-address" placeholder="ä¾‹ï¼šæ±äº¬éƒ½ã€‡ã€‡åŒº"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-head">ğŸ“¦ åŠ å·¥å†…å®¹</div>
    <div class="proc-header"><span>åŠ å·¥ã®ç¨®é¡</span><span>å˜ä¾¡</span><span>å€‹æ•°</span><span>å°è¨ˆ</span></div>
    <div class="proc-list" id="proc-list"></div>
  </div>

  <div class="card">
    <div class="card-head">ğŸ• ä¼šè­°ãƒ»ä»–æ¥­å‹™</div>
    <div class="proc-header" style="margin-bottom:.4rem;"><span>ç¨®åˆ¥</span><span>æ™‚çµ¦</span><span>æ™‚é–“æ•°</span><span>å°è¨ˆ</span></div>
    <div class="proc-row" id="hourly-row">
      <div><span class="proc-name">ä¼šè­° / ä»–æ¥­å‹™</span></div>
      <div style="text-align:center;font-family:'DM Mono',monospace;font-size:.83rem;color:var(--muted);">Â¥1,200</div>
      <input type="number" id="hourly-hours" min="0" step="0.5" value="0" oninput="calculate()">
      <span class="proc-subtotal" id="hourly-sub">Â¥0</span>
    </div>
  </div>

  <div class="bonus-toggle no-print" id="bonus-toggle" onclick="toggleBonus()">
    <div class="tog-switch"></div>
    <div class="tog-text"><div class="tog-main">ï¼‹10% ä¸Šä¹—ã›</div><div class="tog-sub">æœ€çµ‚é‡‘é¡ã«10%ã‚’åŠ ç®—ã™ã‚‹ï¼ˆå¯¾è±¡è€…ã®ã¿ï¼‰</div></div>
  </div>

  <div class="card total-card" style="margin-top:.9rem;">
    <div class="card-head">ğŸ’´ çµ¦æ–™æ˜ç´°</div>
    <div class="total-rows" id="breakdown-rows"></div>
    <hr class="total-sep">
    <div class="grand-total"><span class="gt-label">ä»Šå›æ”¯æ‰•ã„åˆè¨ˆ</span><span class="gt-amount" id="grand-total-display">Â¥0</span></div>
  </div>

  <div class="card">
    <div class="card-head">ğŸ“ å‚™è€ƒ</div>
    <textarea id="remarks" placeholder="ãƒ¡ãƒ¢ã‚„ç‰¹è¨˜äº‹é …ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
  </div>

  <div class="btn-group no-print">
    <button class="btn btn-primary" id="save-btn" onclick="saveRecord(event)">ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜ã™ã‚‹</button>
    <button class="btn btn-secondary" onclick="resetForm()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
</div>

<!-- HISTORY -->
<div class="page" id="page-history">
  <div class="page-header"><h2>å±¥æ­´ãƒ»æ˜ç´°æ›¸</h2><p>ä¿å­˜ã—ãŸè¨˜éŒ²ã®ç¢ºèªã€æœˆæ¬¡æ˜ç´°æ›¸ã®å°åˆ·ãƒ»CSVå‡ºåŠ›</p></div>
  <div class="history-controls no-print">
    <div class="field" style="min-width:155px;"><label>æœˆã§çµã‚Šè¾¼ã¿</label><input type="month" id="filter-month"></div>
    <div class="field" style="min-width:155px;"><label>åå‰ã§çµã‚Šè¾¼ã¿</label><select id="filter-worker"><option value="">å…¨å“¡</option></select></div>
    <div style="margin-top:auto;display:flex;gap:.5rem;">
      <button class="btn btn-primary" onclick="openPrintPreview()">ğŸ–¨ æœˆæ¬¡æ˜ç´°æ›¸</button>
      <button class="btn btn-secondary" onclick="exportCSV()">ğŸ“Š CSVå‡ºåŠ›</button>
    </div>
  </div>
  <div id="month-summary-area"></div>
  <div id="history-list"></div>
</div>

<!-- SETTINGS -->
<div class="page" id="page-settings">
  <div class="page-header"><h2>è¨­å®š</h2><p>ä¼šç¤¾æƒ…å ±ãƒ»å¤–æ³¨ã•ã‚“ã®ç™»éŒ²ãƒ»åŠ å·¥ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®è¿½åŠ ãƒ»å˜ä¾¡å¤‰æ›´</p></div>

  <div class="card">
    <div class="card-head">ğŸ¢ ä¼šç¤¾æƒ…å ±</div>
    <div class="field-row col2">
      <div class="field"><label>ä¼šç¤¾åãƒ»å±‹å·</label><input type="text" id="setting-company" value="WMS"></div>
      <div class="field"><label>æ‹…å½“è€…åï¼ˆä»»æ„ï¼‰</label><input type="text" id="setting-manager" placeholder="ä¾‹ï¼šç”°ä¸­ å¤ªéƒ"></div>
    </div>
    <div class="field-row"><div class="field"><label>ä½æ‰€ï¼ˆä»»æ„ï¼‰</label><input type="text" id="setting-address" placeholder="ä¾‹ï¼šæ±äº¬éƒ½æ¸‹è°·åŒºã€‡ã€‡ 1-2-3"></div></div>
    <button class="btn btn-primary" style="margin-top:.5rem;" onclick="saveCompanySettings(event)">è¨­å®šã‚’ä¿å­˜</button>
  </div>

  <div class="card">
    <div class="card-head">ğŸ‘¤ å¤–æ³¨ã•ã‚“ç™»éŒ²</div>
    <div class="worker-grid" id="worker-settings-list"></div>
    <div style="border-top:1px solid var(--border);padding-top:.85rem;">
      <div style="font-size:.72rem;font-weight:700;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:.6rem;">ï¼‹ æ–°ã—ã„å¤–æ³¨ã•ã‚“ã‚’è¿½åŠ </div>
      <div style="display:flex;align-items:flex-start;gap:1rem;flex-wrap:wrap;">
        <div style="display:flex;flex-direction:column;align-items:center;gap:.35rem;flex-shrink:0;">
          <label class="avatar-upload" id="new-avatar-upload">
            <div class="avatar-upload-ring" id="new-avatar-ring">ğŸ“·</div>
            <input type="file" accept="image/*" onchange="previewNewAvatar(event)">
          </label>
          <span style="font-size:.65rem;color:var(--muted);">å†™çœŸï¼ˆä»»æ„ï¼‰</span>
        </div>
        <div style="flex:1;min-width:220px;">
          <div class="field-row col2">
            <div class="field"><label>åå‰</label><input type="text" id="new-worker-name" placeholder="å±±ç”° èŠ±å­"></div>
            <div class="field"><label>ä½æ‰€</label><input type="text" id="new-worker-addr" placeholder="æ±äº¬éƒ½ã€‡ã€‡åŒº"></div>
          </div>
          <button class="btn btn-green" style="margin-top:.3rem;" onclick="addWorker()">ï¼‹ è¿½åŠ ã™ã‚‹</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-head">ğŸ“¦ åŠ å·¥ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†</div>
    <div id="price-settings-list" style="display:flex;flex-direction:column;gap:.4rem;margin-bottom:.75rem;"></div>
    <div style="border-top:1px solid var(--border);padding-top:.75rem;margin-top:.5rem;">
      <div style="font-size:.72rem;font-weight:700;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:.5rem;">ï¼‹ æ–°ã—ã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ </div>
      <div class="field-row col2">
        <div class="field"><label>ã‚ªãƒ—ã‚·ãƒ§ãƒ³å</label><input type="text" id="new-proc-name" placeholder="ä¾‹ï¼šãƒ©ãƒ™ãƒ«è²¼ã‚Š"></div>
        <div class="field"><label>å˜ä¾¡ï¼ˆå††ï¼‰</label><input type="number" id="new-proc-price" min="1" placeholder="ä¾‹ï¼š30"></div>
      </div>
      <button class="btn btn-green" onclick="addProcess()">ï¼‹ è¿½åŠ ã™ã‚‹</button>
    </div>
    <button class="btn btn-primary" style="margin-top:.75rem;" id="save-prices-btn" onclick="savePrices(event)">å˜ä¾¡ã‚’ä¿å­˜</button>
  </div>
</div>

</main>
</div>

<!-- PRINT OVERLAY -->
<div class="print-overlay no-print" id="print-overlay">
  <div style="width:100%;max-width:230mm;">
    <div class="print-actions">
      <button class="btn btn-primary" onclick="doPrint()">ğŸ–¨ å°åˆ·ã™ã‚‹</button>
      <button class="btn btn-secondary" onclick="closePrint()">âœ• é–‰ã˜ã‚‹</button>
    </div>
    <div class="print-doc" id="print-doc"></div>
  </div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  CONFIG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// API calls go through Netlify Function proxy (/.netlify/functions/jsonbin)
// This keeps the API key server-side and avoids CORS issues
const PROXY_URL = '/.netlify/functions/jsonbin';

const DEFAULT_PROCESSES=[
  {id:'box',name:'ç®±ã«å…¥ã‚Œã‚‹',price:50},
  {id:'waterproof',name:'é˜²æ°´è¢‹ / ãƒ—ãƒãƒ—ãƒ',price:10},
  {id:'roll',name:'ãƒ—ãƒãƒ—ãƒãƒ­ãƒ¼ãƒ«',price:30},
  {id:'compress',name:'åœ§ç¸®',price:70},
  {id:'boxwork',name:'ç®±åŠ å·¥ï¼ˆé€šå¸¸ï¼‰',price:100},
  {id:'boxlarge',name:'ç®±åŠ å·¥ï¼ˆç‰¹å¤§ï¼‰',price:200},
  {id:'set',name:'ã‚»ãƒƒãƒˆæ¢±åŒ…',price:50},
  {id:'danboru',name:'å·»æ®µãƒœãƒ¼ãƒ«',price:50},
  {id:'label',name:'ç™ºé€ä¼ç¥¨æ‰“ã¡è¾¼ã¿',price:50},
];
const HOURLY_RATE=1200;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let processes = DEFAULT_PROCESSES.slice();
let workers = [];
let records = [];
let settings = {company:'WMS',manager:'',address:''};
let bonusOn = false;
let newAvatarData = null;
let isSyncing = false;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  API KEY GATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SYNC STATUS UI
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setSyncStatus(online, label){
  document.getElementById('sync-dot').className='sync-dot'+(online?'':' offline');
  document.getElementById('sync-label').textContent=label;
}

let toastTimer;
function showToast(msg, isErr=false){
  const el=document.getElementById('sync-toast');
  el.textContent=(isErr?'âš ï¸ ':'â˜ï¸ ')+msg;
  el.style.background=isErr?'#b03030':'#1a1f2e';
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>el.classList.remove('show'),2800);
}

function setSyncBar(state){
  const bar=document.getElementById('sync-bar');
  bar.className='';
  void bar.offsetWidth;
  bar.className=state;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  CLOUD STORAGE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function pushData(){
  if(isSyncing)return;
  isSyncing=true;
  setSyncBar('loading');
  setSyncStatus(true,'ä¿å­˜ä¸­...');
  const payload={
    records,workers,settings,processes,
    _updatedAt:new Date().toISOString()
  };
  try{
    const res=await fetch(PROXY_URL,{
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    if(!res.ok)throw new Error(`HTTP ${res.status}`);
    setSyncBar('ok');
    setSyncStatus(true,'åŒæœŸæ¸ˆã¿');
    showToast('ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã—ãŸ');
  }catch(e){
    setSyncBar('err');
    setSyncStatus(false,'åŒæœŸå¤±æ•—');
    showToast('ä¿å­˜å¤±æ•—: '+e.message,true);
  }finally{
    isSyncing=false;
  }
}

async function pullData(){
  setSyncBar('loading');
  setSyncStatus(true,'åŒæœŸä¸­...');
  try{
    const res=await fetch(PROXY_URL,{method:'GET'});
    if(!res.ok)throw new Error(`HTTP ${res.status}`);
    const data=await res.json();
    applyCloudData(data);
    setSyncBar('ok');
    setSyncStatus(true,'åŒæœŸæ¸ˆã¿');
  }catch(e){
    setSyncBar('err');
    setSyncStatus(false,'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³');
    showToast('åŒæœŸå¤±æ•—: '+e.message,true);
  }
}

function applyCloudData(data){
  // data might be wrapped in {record:...} from JSONBin or raw
  const d = data.record !== undefined ? data.record : data;
  if(d && d._updatedAt !== undefined){
    // valid cloud data
    records = d.records || [];
    workers = d.workers || [];
    settings = d.settings || {company:'WMS',manager:'',address:''};
    processes = (d.processes && d.processes.length) ? d.processes : DEFAULT_PROCESSES.slice();
  } else if(d && d.data === 'init'){
    // initial state â€“ push defaults
    records=[]; workers=[]; processes=DEFAULT_PROCESSES.slice();
    settings={company:'WMS',manager:'',address:''};
    pushData();
  }
  reloadUI();
}

async function forcePull(){
  await pullData();
  showToast('ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¾ã—ãŸ');
  reloadUI();
}

function reloadUI(){
  loadCompanySettings();
  buildProcList();
  buildWorkerPicker();
  buildWorkerDatalist();
  calculate();
  renderHistory();
  renderSettingsWorkers();
  renderPriceSettings();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onload=async()=>{
  document.getElementById('work-date').value=new Date().toISOString().slice(0,10);
  document.getElementById('filter-month').value=new Date().toISOString().slice(0,7);
  await pullData();
  reloadUI();
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  UI HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPage(id,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  if(btn)btn.classList.add('active');
  if(id==='history')renderHistory();
  if(id==='settings'){renderPriceSettings();renderSettingsWorkers();}
}

function avatarEl(w,cls=''){
  if(w.avatar)return`<img src="${w.avatar}" class="avatar ${cls}" alt="${w.name}">`;
  const init=(w.name||'?').charAt(0).toUpperCase();
  return`<div class="avatar-placeholder ${cls}">${init}</div>`;
}

function previewNewAvatar(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    newAvatarData=ev.target.result;
    const ring=document.getElementById('new-avatar-ring');
    ring.innerHTML=`<img src="${newAvatarData}" style="width:56px;height:56px;border-radius:50%;object-fit:cover;">`;
    ring.classList.add('has-img');
  };
  reader.readAsDataURL(file);
}

function buildWorkerPicker(){
  const el=document.getElementById('worker-picker');if(!el)return;
  if(!workers.length){
    el.innerHTML='<span style="color:var(--muted);font-size:.82rem;">è¨­å®šãƒšãƒ¼ã‚¸ã§å¤–æ³¨ã•ã‚“ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</span>';
    return;
  }
  el.innerHTML=workers.map(w=>`
    <div class="worker-chip" id="chip-${w.id}" onclick="selectWorkerChip('${w.id}')">
      ${avatarEl(w,'avatar-sm')}
      <span>${w.name}</span>
    </div>
  `).join('');
}

function selectWorkerChip(id){
  const w=workers.find(x=>x.id===id);if(!w)return;
  document.querySelectorAll('.worker-chip').forEach(c=>c.classList.remove('selected'));
  document.getElementById('chip-'+id)?.classList.add('selected');
  document.getElementById('worker-name').value=w.name;
  document.getElementById('worker-address').value=w.address||'';
}

function buildWorkerDatalist(){
  const dl=document.getElementById('worker-list');
  if(dl)dl.innerHTML=workers.map(w=>`<option value="${w.name}">`).join('');
}

function buildProcList(){
  const el=document.getElementById('proc-list');el.innerHTML='';
  processes.forEach(p=>{
    const row=document.createElement('div');
    row.className='proc-row';row.id='proc-row-'+p.id;
    row.innerHTML=`
      <div><span class="proc-name">${p.name}</span></div>
      <div style="text-align:center;font-family:'DM Mono',monospace;font-size:.83rem;color:var(--muted);">Â¥${p.price.toLocaleString()}</div>
      <input type="number" id="qty-${p.id}" min="0" step="1" value="0" oninput="calculate()">
      <span class="proc-subtotal" id="sub-${p.id}">Â¥0</span>
    `;
    el.appendChild(row);
  });
}

function calculate(){
  let items=[],baseTotal=0;
  processes.forEach(p=>{
    const qty=parseInt(document.getElementById('qty-'+p.id)?.value)||0;
    const sub=qty*p.price;
    const sEl=document.getElementById('sub-'+p.id),rEl=document.getElementById('proc-row-'+p.id);
    if(sEl){sEl.textContent='Â¥'+sub.toLocaleString();sEl.className='proc-subtotal'+(sub>0?' active':'');}
    if(rEl)rEl.classList.toggle('has-value',qty>0);
    if(qty>0)items.push({name:p.name,price:p.price,qty,sub});
    baseTotal+=sub;
  });
  const hours=parseFloat(document.getElementById('hourly-hours')?.value)||0;
  const hSub=Math.round(hours*HOURLY_RATE);
  const hEl=document.getElementById('hourly-sub'),hRow=document.getElementById('hourly-row');
  if(hEl){hEl.textContent='Â¥'+hSub.toLocaleString();hEl.className='proc-subtotal'+(hSub>0?' active':'');}
  if(hRow)hRow.classList.toggle('has-value',hours>0);
  if(hours>0)items.push({name:`ä¼šè­°ãƒ»ä»–æ¥­å‹™ (${hours}h)`,price:HOURLY_RATE,qty:hours,sub:hSub,isHourly:true});
  baseTotal+=hSub;
  const bonusAmt=bonusOn?Math.round(baseTotal*.1):0;
  const total=baseTotal+bonusAmt;
  const bd=document.getElementById('breakdown-rows');bd.innerHTML='';
  if(!items.length){
    bd.innerHTML='<div class="total-row" style="color:rgba(255,255,255,.28);">ï¼ˆåŠ å·¥å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼‰</div>';
  }else{
    items.forEach(it=>{
      const r=document.createElement('div');r.className='total-row';
      r.innerHTML=`<span>${it.name} <span style="font-size:.76rem;opacity:.55;">${it.isHourly?it.qty+'h':it.qty+'å€‹'} Ã— Â¥${it.price.toLocaleString()}</span></span><span>Â¥${it.sub.toLocaleString()}</span>`;
      bd.appendChild(r);
    });
    if(bonusOn&&bonusAmt>0){
      const s=document.createElement('hr');s.className='total-sep';bd.appendChild(s);
      const r1=document.createElement('div');r1.className='total-row bold';
      r1.innerHTML=`<span>å°è¨ˆ</span><span>Â¥${baseTotal.toLocaleString()}</span>`;bd.appendChild(r1);
      const r2=document.createElement('div');r2.className='total-row bold';
      r2.innerHTML=`<span>ï¼‹10% ä¸Šä¹—ã›</span><span>Â¥${bonusAmt.toLocaleString()}</span>`;bd.appendChild(r2);
    }
  }
  document.getElementById('grand-total-display').textContent='Â¥'+total.toLocaleString();
  return{items,baseTotal,bonusAmt,total};
}

function toggleBonus(){
  bonusOn=!bonusOn;
  document.getElementById('bonus-toggle').classList.toggle('on',bonusOn);
  calculate();
}

async function saveRecord(e){
  const name=document.getElementById('worker-name').value.trim();
  const date=document.getElementById('work-date').value;
  if(!name){alert('å¤–æ³¨ã•ã‚“ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  if(!date){alert('ä½œæ¥­æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  const{items,baseTotal,bonusAmt,total}=calculate();
  const address=document.getElementById('worker-address').value.trim();
  const remarks=document.getElementById('remarks').value.trim();
  const wObj=workers.find(w=>w.name===name);
  const avatar=wObj?wObj.avatar||null:null;
  const record={
    id:Date.now(),date,name,address,remarks,avatar,
    bonusOn,bonusAmt,items,baseTotal,total,
    hours:parseFloat(document.getElementById('hourly-hours').value)||0,
    createdAt:new Date().toLocaleString('ja-JP')
  };
  records.unshift(record);
  if(records.length>500)records=records.slice(0,500);
  if(name&&!workers.find(w=>w.name===name)){
    workers.push({id:'w'+Date.now(),name,address,avatar:null});
    buildWorkerPicker();buildWorkerDatalist();renderSettingsWorkers();
  }
  const btn=e.currentTarget;
  btn.textContent='â³ ä¿å­˜ä¸­...';btn.disabled=true;
  await pushData();
  btn.textContent='âœ… ä¿å­˜ã—ã¾ã—ãŸï¼';
  setTimeout(()=>{btn.textContent='ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜ã™ã‚‹';btn.disabled=false;},1800);
  renderHistory();
}

function resetForm(){
  if(!confirm('å…¥åŠ›å†…å®¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ'))return;
  processes.forEach(p=>{const el=document.getElementById('qty-'+p.id);if(el)el.value=0;});
  document.getElementById('hourly-hours').value=0;
  document.getElementById('remarks').value='';
  bonusOn=false;
  document.getElementById('bonus-toggle').classList.remove('on');
  document.querySelectorAll('.worker-chip').forEach(c=>c.classList.remove('selected'));
  calculate();
}

function renderHistory(){
  const month=document.getElementById('filter-month')?.value||'';
  const wf=document.getElementById('filter-worker')?.value||'';
  let filtered=records;
  if(month)filtered=filtered.filter(r=>r.date.startsWith(month));
  if(wf)filtered=filtered.filter(r=>r.name===wf);
  const wSel=document.getElementById('filter-worker');
  if(wSel){
    const cur=wSel.value,names=[...new Set(records.map(r=>r.name))].sort();
    wSel.innerHTML='<option value="">å…¨å“¡</option>'+names.map(n=>`<option value="${n}"${n===cur?' selected':''}>${n}</option>`).join('');
  }
  const sum=document.getElementById('month-summary-area');
  if(filtered.length>0&&sum){
    const tp=filtered.reduce((a,r)=>a+r.total,0),wi=[...new Set(filtered.map(r=>r.name))].length;
    sum.innerHTML=`<div class="month-summary">
      <div class="summary-stat"><span class="stat-label">ä»¶æ•°</span><span class="stat-value">${filtered.length}ä»¶</span></div>
      <div class="summary-stat"><span class="stat-label">å¤–æ³¨äººæ•°</span><span class="stat-value">${wi}å</span></div>
      <div class="summary-stat"><span class="stat-label">æ”¯æ‰•åˆè¨ˆ</span><span class="stat-value accent">Â¥${tp.toLocaleString()}</span></div>
      <div class="summary-stat"><span class="stat-label">æ¶ˆè²»ç¨(10%)</span><span class="stat-value">Â¥${Math.round(tp*.1).toLocaleString()}</span></div>
      <div class="summary-stat"><span class="stat-label">ç¨è¾¼åˆè¨ˆ</span><span class="stat-value accent">Â¥${Math.round(tp*1.1).toLocaleString()}</span></div>
    </div>`;
  }else if(sum)sum.innerHTML='';

  const el=document.getElementById('history-list');if(!el)return;
  if(!filtered.length){
    el.innerHTML='<div class="empty"><div class="icon">ğŸ“­</div><div>è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div></div>';
    return;
  }

  function getAvatar(r,sm=false){
    const w=workers.find(x=>x.name===r.name);
    const av=r.avatar||(w?w.avatar:null);
    const cls=sm?'avatar-sm':'avatar';
    if(av)return`<img src="${av}" class="${cls}" alt="${r.name}">`;
    const init=(r.name||'?').charAt(0).toUpperCase();
    return`<div class="avatar-placeholder ${sm?'avatar-sm':''}">${init}</div>`;
  }

  el.innerHTML=filtered.map(r=>{
    const tax=Math.round(r.total*.1),wt=r.total+tax;
    const summary=r.items.map(it=>it.name).join('ãƒ»');
    return`<div class="record-card">
      <div class="record-header" onclick="toggleDetail(${r.id})">
        <div class="record-left">
          ${getAvatar(r)}
          <span class="record-date-badge">${r.date}</span>
          <div>
            <div class="record-name">${r.name}${r.bonusOn?` <span style="font-size:.7rem;color:var(--accent);font-weight:700;">+10%</span>`:''}</div>
            <div class="record-summary">${summary||'ï¼ˆåŠ å·¥ãªã—ï¼‰'}${r.address?' Â· '+r.address:''}</div>
          </div>
        </div>
        <span class="record-amount">Â¥${r.total.toLocaleString()}</span>
        <div class="record-actions">
          <button class="icon-btn" onclick="event.stopPropagation();printSingle(${r.id})" title="å°åˆ·">ğŸ–¨</button>
          <button class="icon-btn del" onclick="event.stopPropagation();deleteRecord(${r.id})" title="å‰Šé™¤">âœ•</button>
        </div>
      </div>
      <div class="record-detail" id="detail-${r.id}">
        <table class="mini-table">
          <tr><th>åŠ å·¥ã®ç¨®é¡</th><th>å˜ä¾¡</th><th>æ•°é‡</th><th>å°è¨ˆ</th></tr>
          ${r.items.map(it=>`<tr><td>${it.name}</td><td class="num">Â¥${it.price.toLocaleString()}</td><td class="num">${it.isHourly?it.qty+'h':it.qty+'å€‹'}</td><td class="num">Â¥${it.sub.toLocaleString()}</td></tr>`).join('')}
          ${r.bonusOn?`<tr><td>å°è¨ˆ</td><td class="num" colspan="2"></td><td class="num">Â¥${r.baseTotal.toLocaleString()}</td></tr><tr><td>ï¼‹10%ä¸Šä¹—ã›</td><td class="num" colspan="2"></td><td class="num">Â¥${r.bonusAmt.toLocaleString()}</td></tr>`:''}
          <tr class="subtotal-row"><td colspan="3">æ”¯æ‰•åˆè¨ˆï¼ˆç¨æŠœï¼‰</td><td class="num">Â¥${r.total.toLocaleString()}</td></tr>
          <tr class="subtotal-row"><td colspan="3">æ¶ˆè²»ç¨ï¼ˆ10%ï¼‰</td><td class="num">Â¥${tax.toLocaleString()}</td></tr>
          <tr class="subtotal-row"><td colspan="3">ç¨è¾¼åˆè¨ˆ</td><td class="num">Â¥${wt.toLocaleString()}</td></tr>
        </table>
        ${r.remarks?`<div style="margin-top:.65rem;font-size:.8rem;color:var(--muted);">å‚™è€ƒï¼š${r.remarks}</div>`:''}
      </div>
    </div>`;
  }).join('');
}

function toggleDetail(id){document.getElementById('detail-'+id)?.classList.toggle('open');}

async function deleteRecord(id){
  if(!confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
  records=records.filter(r=>r.id!==id);
  await pushData();
  renderHistory();
}

function renderSettingsWorkers(){
  const el=document.getElementById('worker-settings-list');if(!el)return;
  if(!workers.length){
    el.innerHTML='<div style="color:var(--muted);font-size:.83rem;grid-column:1/-1;">ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
    return;
  }
  el.innerHTML=workers.map((w,i)=>`
    <div class="worker-card-sm">
      <button class="del-btn" onclick="removeWorker(${i})" title="å‰Šé™¤">âœ•</button>
      ${w.avatar
        ?`<img src="${w.avatar}" class="avatar avatar-lg" alt="${w.name}" style="width:56px;height:56px;">`
        :`<div class="avatar-placeholder avatar-lg">${(w.name||'?').charAt(0).toUpperCase()}</div>`
      }
      <div class="wname">${w.name}</div>
      ${w.address?`<div class="waddr">${w.address}</div>`:''}
      <label style="cursor:pointer;font-size:.68rem;color:var(--accent);margin-top:2px;">
        ğŸ“· å†™çœŸã‚’å¤‰æ›´
        <input type="file" accept="image/*" style="display:none;" onchange="changeWorkerAvatar(${i},event)">
      </label>
    </div>
  `).join('');
}

function changeWorkerAvatar(i,e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=async ev=>{
    workers[i].avatar=ev.target.result;
    renderSettingsWorkers();buildWorkerPicker();
    await pushData();
  };
  reader.readAsDataURL(file);
}

async function addWorker(){
  const name=document.getElementById('new-worker-name').value.trim();
  const addr=document.getElementById('new-worker-addr').value.trim();
  if(!name){alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  if(workers.find(w=>w.name===name)){alert('ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');return;}
  workers.push({id:'w'+Date.now(),name,address:addr,avatar:newAvatarData||null});
  document.getElementById('new-worker-name').value='';
  document.getElementById('new-worker-addr').value='';
  newAvatarData=null;
  const ring=document.getElementById('new-avatar-ring');
  ring.innerHTML='ğŸ“·';ring.classList.remove('has-img');
  buildWorkerPicker();buildWorkerDatalist();renderSettingsWorkers();
  await pushData();
}

async function removeWorker(i){
  if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
  workers.splice(i,1);
  buildWorkerPicker();buildWorkerDatalist();renderSettingsWorkers();
  await pushData();
}

function renderPriceSettings(){
  const el=document.getElementById('price-settings-list');if(!el)return;
  el.innerHTML=processes.map((p,i)=>`
    <div class="price-row">
      <span>${p.name}</span>
      <div style="display:flex;align-items:center;gap:.3rem;">
        <span style="font-size:.78rem;color:var(--muted);">Â¥</span>
        <input type="number" id="price-${p.id}" value="${p.price}" min="1" style="width:80px;text-align:right;">
      </div>
      <button class="icon-btn del btn-sm" onclick="removeProcess(${i})" title="å‰Šé™¤">âœ•</button>
    </div>
  `).join('');
}

async function addProcess(){
  const name=document.getElementById('new-proc-name').value.trim();
  const price=parseInt(document.getElementById('new-proc-price').value);
  if(!name){alert('ã‚ªãƒ—ã‚·ãƒ§ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  if(!price||price<1){alert('å˜ä¾¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  processes.push({id:'custom_'+Date.now(),name,price});
  document.getElementById('new-proc-name').value='';
  document.getElementById('new-proc-price').value='';
  buildProcList();calculate();renderPriceSettings();
  const btn=event.currentTarget;btn.textContent='â³...';btn.disabled=true;
  await pushData();
  btn.textContent='âœ… è¿½åŠ ã—ã¾ã—ãŸ';
  setTimeout(()=>{btn.textContent='ï¼‹ è¿½åŠ ã™ã‚‹';btn.disabled=false;},1500);
}

async function removeProcess(i){
  if(!confirm(`ã€Œ${processes[i].name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`))return;
  processes.splice(i,1);
  buildProcList();calculate();renderPriceSettings();
  await pushData();
}

async function savePrices(e){
  processes.forEach(p=>{const el=document.getElementById('price-'+p.id);if(el)p.price=parseInt(el.value)||p.price;});
  buildProcList();calculate();
  const btn=e.currentTarget;btn.textContent='â³ ä¿å­˜ä¸­...';btn.disabled=true;
  await pushData();
  btn.textContent='âœ… ä¿å­˜ã—ã¾ã—ãŸ';
  setTimeout(()=>{btn.textContent='å˜ä¾¡ã‚’ä¿å­˜';btn.disabled=false;},1500);
}

function loadCompanySettings(){
  document.getElementById('setting-company').value=settings.company||'WMS';
  document.getElementById('setting-manager').value=settings.manager||'';
  document.getElementById('setting-address').value=settings.address||'';
}

async function saveCompanySettings(e){
  settings.company=document.getElementById('setting-company').value.trim();
  settings.manager=document.getElementById('setting-manager').value.trim();
  settings.address=document.getElementById('setting-address').value.trim();
  const btn=e.currentTarget;btn.textContent='â³ ä¿å­˜ä¸­...';btn.disabled=true;
  await pushData();
  btn.textContent='âœ… ä¿å­˜ã—ã¾ã—ãŸ';
  setTimeout(()=>{btn.textContent='è¨­å®šã‚’ä¿å­˜';btn.disabled=false;},1500);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  PRINT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildPrintDoc(recs,title){
  if(!recs.length)return'<p>å¯¾è±¡ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>';
  const comp=settings.company||'WMS',mgr=settings.manager||'',addr=settings.address||'';
  const wn=recs[0].name,wa=recs[0].address||'',month=recs[0].date.slice(0,7);
  const tp=recs.reduce((a,r)=>a+r.total,0),tax=Math.round(tp*.1),wt=tp+tax;
  const docNo=`${month.replace('-','')}-${wn.replace(/\s/g,'')}`;
  let rows='';
  recs.forEach(r=>{
    r.items.forEach((it,i)=>{
      rows+=`<tr><td class="date-col">${i===0?r.date:''}</td><td>${it.name}</td><td class="num">Â¥${it.price.toLocaleString()}</td><td class="num">${it.isHourly?it.qty+'h':it.qty+'å€‹'}</td><td class="num">Â¥${it.sub.toLocaleString()}</td><td class="num">Â¥${Math.round(it.sub*.1).toLocaleString()}</td></tr>`;
    });
    if(r.bonusOn)rows+=`<tr><td></td><td>ï¼‹10%ä¸Šä¹—ã›</td><td></td><td></td><td class="num">Â¥${r.bonusAmt.toLocaleString()}</td><td class="num">Â¥${Math.round(r.bonusAmt*.1).toLocaleString()}</td></tr>`;
    rows+=`<tr class="subtotal-row"><td class="date-col">${r.date}</td><td colspan="3">æ—¥è¨ˆ</td><td class="num">Â¥${r.total.toLocaleString()}</td><td class="num">Â¥${Math.round(r.total*.1).toLocaleString()}</td></tr>`;
  });
  const remarks=recs.filter(r=>r.remarks).map(r=>`[${r.date}] ${r.remarks}`).join('\n');
  return`
    <div class="doc-header">
      <div><div class="doc-title">æ”¯ æ‰• æ˜ ç´° æ›¸</div><div class="doc-no">æ–‡æ›¸ç•ªå·ï¼š${docNo}</div></div>
      <div class="doc-issuer"><div class="company">${comp}</div>${mgr?`<div class="sub">æ‹…å½“ï¼š${mgr}</div>`:''}${addr?`<div class="sub">${addr}</div>`:''}</div>
    </div>
    <div class="doc-meta">
      <div class="meta-box"><div class="meta-label">æ”¯æ‰•å…ˆ</div><div class="meta-value">${wn} æ§˜</div>${wa?`<div style="font-size:8.5pt;color:#555;margin-top:1mm;">${wa}</div>`:''}</div>
      <div class="meta-box"><div class="meta-label">å¯¾è±¡æœŸé–“</div><div class="meta-value">${title}</div><div style="font-size:7.5pt;color:#555;margin-top:1mm;">ä½œæ¥­ä»¶æ•°ï¼š${recs.length}ä»¶</div></div>
    </div>
    <div class="doc-period-bar">â–  åŠ å·¥ä½œæ¥­æ˜ç´°</div>
    <table class="doc-table">
      <thead><tr><th style="width:22mm;">ä½œæ¥­æ—¥</th><th>åŠ å·¥ã®ç¨®é¡</th><th style="width:17mm;">å˜ä¾¡</th><th style="width:17mm;">æ•°é‡</th><th style="width:21mm;">é‡‘é¡ï¼ˆç¨æŠœï¼‰</th><th style="width:17mm;">æ¶ˆè²»ç¨</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
    <div class="clearfix">
      <div class="doc-totals">
        <div class="doc-totals-row"><span>ç¨æŠœåˆè¨ˆ</span><span>Â¥${tp.toLocaleString()}</span></div>
        <div class="doc-totals-row"><span>æ¶ˆè²»ç¨ï¼ˆ10%ï¼‰</span><span>Â¥${tax.toLocaleString()}</span></div>
        <div class="doc-totals-row"><span>ç¨è¾¼åˆè¨ˆ</span><span>Â¥${wt.toLocaleString()}</span></div>
      </div>
      <div class="doc-remarks"><div class="doc-remarks-label">å‚™è€ƒ</div><div class="doc-remarks-text">${remarks||'ã€€'}</div></div>
    </div>
    <div class="doc-seal-area">
      <div class="seal-box"><div class="seal-circle"></div><div class="seal-label">ç¢ºèªå°</div></div>
      <div class="seal-box"><div class="seal-circle"></div><div class="seal-label">æ‰¿èªå°</div></div>
    </div>
    <div class="doc-footer">æœ¬æ˜ç´°æ›¸ã¯${new Date().toLocaleDateString('ja-JP')}ã«ç™ºè¡Œã•ã‚Œã¾ã—ãŸã€‚ | ${comp}</div>
  `;
}

function openPrintPreview(){
  const month=document.getElementById('filter-month').value,wf=document.getElementById('filter-worker').value;
  if(!month){alert('æœˆã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  let f=records.filter(r=>r.date.startsWith(month));
  if(wf)f=f.filter(r=>r.name===wf);
  if(!f.length){alert('å¯¾è±¡ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“');return;}
  const[y,m]=month.split('-');
  document.getElementById('print-doc').innerHTML=buildPrintDoc(f,`${y}å¹´${parseInt(m)}æœˆåˆ†`);
  document.getElementById('print-overlay').classList.add('open');
}

function printSingle(id){
  const r=records.find(h=>h.id===id);if(!r)return;
  document.getElementById('print-doc').innerHTML=buildPrintDoc([r],r.date+'åˆ†');
  document.getElementById('print-overlay').classList.add('open');
}

function closePrint(){document.getElementById('print-overlay').classList.remove('open');}

function doPrint(){
  const html=document.getElementById('print-doc').innerHTML;
  const win=window.open('','_blank','width=900,height=700');
  win.document.write(`<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Noto+Serif+JP:wght@400;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"><style>body{font-family:'Noto Serif JP',serif;margin:0;padding:18mm 16mm;color:#000;}.doc-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:7mm;padding-bottom:4mm;border-bottom:2px solid #000;}.doc-title{font-size:21pt;font-weight:700;letter-spacing:4px;}.doc-no{font-size:7.5pt;color:#555;margin-top:2mm;font-family:'DM Mono',monospace;}.doc-issuer{text-align:right;}.doc-issuer .company{font-size:12pt;font-weight:700;}.doc-issuer .sub{font-size:7.5pt;color:#555;}.doc-meta{display:grid;grid-template-columns:1fr 1fr;gap:4mm;margin-bottom:6mm;}.meta-box{border:1px solid #ccc;border-radius:3px;padding:2.5mm 3.5mm;}.meta-label{font-size:7pt;color:#777;letter-spacing:1px;text-transform:uppercase;margin-bottom:1mm;}.meta-value{font-size:10.5pt;font-weight:700;}.doc-period-bar{background:#1a1f2e;color:#fff;padding:2mm 4mm;font-size:8.5pt;font-weight:700;letter-spacing:1px;margin-bottom:4.5mm;border-radius:2px;}.doc-table{width:100%;border-collapse:collapse;margin-bottom:4.5mm;}.doc-table th{background:#eef3ff;border:1px solid #ccc;padding:1.8mm 2.5mm;font-size:7.5pt;text-align:center;font-weight:700;}.doc-table td{border:1px solid #ccc;padding:2mm 2.5mm;font-size:8.5pt;vertical-align:middle;}.doc-table td.num{text-align:right;font-family:'DM Mono',monospace;}.doc-table tr:nth-child(even) td{background:#f7f9ff;}.doc-table .date-col{font-family:'DM Mono',monospace;font-size:7.5pt;color:#555;}.doc-table .subtotal-row td{background:#eef3ff;font-weight:700;}.doc-totals{float:right;width:62mm;border:1px solid #ccc;border-radius:3px;overflow:hidden;margin-bottom:4.5mm;}.doc-totals-row{display:flex;justify-content:space-between;padding:1.8mm 3.5mm;font-size:8.5pt;border-bottom:1px solid #eee;}.doc-totals-row:last-child{background:#1a1f2e;color:#fff;font-weight:700;font-size:10.5pt;border-bottom:none;}.clearfix::after{content:'';display:table;clear:both;}.doc-remarks{clear:both;border:1px solid #ccc;border-radius:3px;padding:2.5mm 3.5mm;margin-bottom:4.5mm;min-height:18mm;}.doc-remarks-label{font-size:7pt;color:#777;letter-spacing:1px;text-transform:uppercase;margin-bottom:1.5mm;}.doc-remarks-text{font-size:8.5pt;white-space:pre-wrap;}.doc-seal-area{display:flex;justify-content:flex-end;gap:4.5mm;margin-top:4mm;}.seal-box{text-align:center;width:20mm;}.seal-circle{width:16mm;height:16mm;border:1px solid #ccc;border-radius:50%;margin:0 auto 1mm;}.seal-label{font-size:6.5pt;color:#777;}.doc-footer{text-align:center;font-size:6.5pt;color:#aaa;border-top:1px solid #e0e0e0;padding-top:2.5mm;margin-top:5mm;}@media print{body{margin:0;padding:15mm 12mm;}@page{margin:0;size:A4;}}</style></head><body>${html}</body></html>`);
  win.document.close();win.onload=()=>{win.focus();win.print();};
}

function exportCSV(){
  const month=document.getElementById('filter-month').value,wf=document.getElementById('filter-worker').value;
  let f=records;
  if(month)f=f.filter(r=>r.date.startsWith(month));
  if(wf)f=f.filter(r=>r.name===wf);
  if(!f.length){alert('å¯¾è±¡ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“');return;}
  const rows=[['ä½œæ¥­æ—¥','åå‰','ä½æ‰€','åŠ å·¥ã®ç¨®é¡','å˜ä¾¡','æ•°é‡','å°è¨ˆ','10%ä¸Šä¹—ã›','åˆè¨ˆ','æ¶ˆè²»ç¨','ç¨è¾¼åˆè¨ˆ','å‚™è€ƒ']];
  f.forEach(r=>{r.items.forEach((it,i)=>{rows.push([r.date,r.name,r.address||'',it.name,it.price,it.isHourly?it.qty+'h':it.qty,it.sub,i===0?(r.bonusOn?'æœ‰':'ç„¡'):'',i===0?r.total:'',i===0?Math.round(r.total*.1):'',i===0?Math.round(r.total*1.1):'',i===0?(r.remarks||''):'']);});});
  const bom='\uFEFF',csv=bom+rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));a.download=`WMS_çµ¦æ–™_${month||'all'}.csv`;a.click();
}
</script>
</body>
</html>
